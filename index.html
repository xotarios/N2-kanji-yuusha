<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>N2æ¼¢å­—å‹‡è€…</title>
    <link href="https://fonts.googleapis.com/css2?family=Kaisei+Tokumin:wght@400;700&family=DotGothic16&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1a1c2c;
            --box-bg: rgba(41, 43, 65, 0.95);
            --border-color: #f4f4f4;
            --highlight: #f1c40f;
            --hp-color: #2ecc71;
            --danger: #e74c3c;
            --text-main: #ffffff;
            --text-sub: #bdc3c7;
            --font-main: 'Kaisei Tokumin', serif;
            --font-ui: 'DotGothic16', sans-serif;
            --key-bg: #4a4d66;
        }

        body {
            background-color: var(--bg-color);
            /* èƒŒæ™¯åœ–äº¤ç”± #background-layer è™•ç†ï¼Œé€™è£¡ä¿æŒé€æ˜æˆ–åº•è‰² */
            color: var(--text-main);
            font-family: var(--font-main);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            overscroll-behavior: none;
            box-sizing: border-box;
        }

        /* ç¨ç«‹èƒŒæ™¯å±¤ (ç”¨æ–¼éå ´å‹•ç•«æ”¾å¤§è®Šæš—) */
        #background-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background-size: cover;
            background-position: center;
            transition: transform 2s ease-in-out, filter 2s ease-in-out;
        }

        /* éå ´å‹•ç•«ç‹€æ…‹ */
        .stage-entering #background-layer {
            transform: scale(1.2);
            filter: brightness(0.4);
        }

        /* =========================================
           Start Screen Styling
           ========================================= */
        #start-screen {
            /* Title Background Image */
            background: url('https://raw.githubusercontent.com/xotarios/N2-kanji-yuusha/refs/heads/main/images/N2yuusha_2.png') no-repeat center top;
            background-size: cover;
            
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            
            /* é™åˆ¶åœ¨æ‰‹æ©Ÿå¯¬åº¦ä¸¦ç½®ä¸­ */
            position: fixed;
            top: 0;
            height: 100%;
            width: 100%;
            max-width: 600px;
            left: 50%;
            transform: translateX(-50%);
            
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            z-index: 2000;
        }

        /* Hide text title as image has it */
        #start-screen .title-logo {
            display: none;
        }

        /* Content positioning */
        #start-screen .result-content {
            padding-bottom: 5vh; /* é¿é–‹åœ–ç‰‡æ¨™é¡Œ */
            max-width: 800px;
            margin: 0 auto;
            color: white;
            text-align: center;
            width: 90%;
        }

        .start-credits {
            margin-top: 30px;
            font-size: 0.8rem;
            color: #ddd;
            line-height: 1.6;
            font-family: var(--font-ui);
            text-shadow: 2px 2px 2px #000;
            background: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 8px;
            text-align: left;
            display: inline-block;
        }

        /* =========================================
           Game Container & Layout
           ========================================= */
        .game-container {
            width: 90%;
            max-width: 600px;
            background: var(--box-bg);
            border: 4px double var(--border-color);
            border-radius: 8px;
            padding: 20px;
            padding-bottom: 60px; /* Space for return button */
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            position: relative;
            backdrop-filter: blur(5px);
            /* èƒŒæ™¯æ¿¾é¡è®Šè‰²ç”± JS æ§åˆ¶ (gameContainer.style.background) */
            transition: box-shadow 0.3s ease;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 25px;
            font-family: var(--font-ui);
        }

        .header-left {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .stage-name-small {
            font-size: 0.85rem;
            color: #aaa;
            font-weight: bold;
        }

        .hp-container {
            width: 50%;
            background: #000;
            border: 2px solid var(--border-color);
            height: 20px;
            position: relative;
            margin-top: 5px;
        }

        .hp-bar {
            height: 100%;
            background: var(--hp-color);
            width: 100%;
            transition: width 0.3s ease;
        }

        /* HP Text below bar */
        .hp-text {
            position: absolute;
            bottom: -22px;
            right: 0;
            font-size: 0.85em;
            color: var(--text-main);
            text-shadow: 1px 1px 0 #000;
            font-family: var(--font-ui);
        }

             
        #boss-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 3000;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        animation: fadeIn 0.5s;
        }

        .boss-intro-banner {
        width: 100%;
        background: linear-gradient(90deg, transparent, #870000, transparent);
        padding: 20px 0;
        text-align: center;
        color: #fff;
        font-family: var(--font-ui);
        border-top: 2px solid #ff0000;
        border-bottom: 2px solid #ff0000;
        margin-bottom: 20px;
            position: relative;
        }

        .boss-intro-title {
        font-size: 2rem;
        font-weight: bold;
        text-shadow: 0 0 10px #ff0000;
        margin-bottom: 10px;
        }

        .boss-intro-img-container {
        width: 150px;
        height: 150px;
        margin: 0 auto;
        filter: drop-shadow(0 0 15px rgba(255, 0, 0, 0.8));
        }
    
        .boss-intro-img {
        width: 100%; height: 100%; object-fit: contain;
        }

        .boss-intro-desc {
        font-size: 1.2rem;
        margin-top: 10px;
        color: #f1c40f;
        }

        .boss-start-btn {
        background: #e74c3c;
        border: 2px solid #fff;
        color: white;
        font-size: 1.5rem;
        font-family: var(--font-ui);
        cursor: pointer;
        transition: transform 0.2s;
        animation: pulse 1s infinite;
        display: flex;
        justify-content: center;
        align-items: center;
        width: fit-content;      /* å¯¬åº¦éš¨æ–‡å­—ç¸®æ”¾ */
        min-width: 200px;        /* æœ€å°å¯¬åº¦ */
        height: 60px;            /* â˜…å›ºå®šé«˜åº¦ï¼Œè§£æ±ºå¤ªé•·å•é¡Œâ˜… */
        padding: 0 20px;         /* å·¦å³ç•™ç™½ */
        margin: 20px auto 0;     /* èˆ‡ä¸Šæ–¹æ©«æ¢ä¿æŒè·é›¢ï¼Œä¸¦ç½®ä¸­ */
        flex: none;              /* â˜…é—œéµï¼šé˜²æ­¢è¢«çˆ¶å®¹å™¨æ‹‰ä¼¸â˜… */
    }
    
        .boss-start-btn:hover {
        transform: scale(1.1);
        background: #c0392b;
        }

        /* Boss Battle UI tweaks */
        #boss-section {
        display: none;
        flex-direction: column;
        align-items: center;
        margin-bottom: 10px;
        }

        .boss-image-container {
            position: relative;
            width: 120px;
            height: 120px;
            margin-bottom: 5px;
        }

        .boss-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 0 10px rgba(255,0,0,0.5));
            transition: filter 0.2s;
        }

        .boss-hp-bar-container {
            width: 80%;
            height: 15px;
            background: #333;
            border: 2px solid #fff;
            margin-bottom: 5px;
            position: relative;
        }

        .boss-hp-bar {
            width: 100%;
            height: 100%;
            background: #e74c3c;
            transition: width 0.3s ease;
        }

        .boss-timer {
            font-family: var(--font-ui);
            font-size: 1.5rem;
            color: #f1c40f;
            text-shadow: 2px 2px 0 #000;
        }

        .boss-display-container {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        margin-bottom: 10px;
        position: relative;
        }

        /* ç²—ç·å­—é«”æ¨£å¼ */
         .boss-text-style {
        font-family: "Arial Black", "Impact", sans-serif; /* ç²—é«” */
        color: white;
        text-shadow: 3px 3px 0 #000, -1px -1px 0 #000;
        font-size: 1.5rem;
        font-weight: 900;
        letter-spacing: 0.1em;
        white-space: nowrap;
        }

        .boss-title-label {
        text-align: right;
        color: #f1c40f; /* é‡‘è‰²ç¨±è™Ÿ */
        transform: rotate(-5deg); /* ç¨å¾®å‚¾æ–œå¢åŠ å‹•æ„Ÿ */
        }

        .boss-name-label {
        text-align: left;
        color: #e74c3c; /* ç´…è‰²åå­— */
        transform: rotate(5deg);
        }

        .boss-name-ruby {
        display: block;
        font-size: 0.5em;
        color: #fff;
        text-shadow: 1px 1px 0 #000;
        margin-bottom: -5px;
        text-align: center;
        font-weight: normal;
        }

        /* Boss Dialogue Box */
        .boss-dialogue {
        background: rgba(0, 0, 0, 0.8);
        border: 2px solid #fff;
        border-radius: 8px;
        padding: 10px 15px;
        color: #fff;
        font-family: var(--font-ui);
        font-size: 1rem;
        min-height: 3.6em; /* é ç•™å…©è¡Œç©ºé–“ */
        width: 90%;
        max-width: 500px;
        margin: 10px auto;
        text-align: left;
        line-height: 1.6;
        box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        .boss-silhouette {
        /* è®Šå…¨é»‘ + ç™½è‰²å¤–ç™¼å…‰ */
        filter: brightness(0) drop-shadow(0 0 15px rgba(255, 255, 255, 0.9)) !important;
        opacity: 0.8;
        transition: filter 0.5s ease;
        }


        /* â˜…â˜…â˜… æ–°å¢ï¼šå¯†ç¢¼çå‹µæ¡†æ¨£å¼ â˜…â˜…â˜… */
        .password-reward-box {
        background: rgba(241, 196, 15, 0.2); /* é‡‘è‰²åŠé€æ˜èƒŒæ™¯ */
        border: 2px solid #f1c40f;
        border-radius: 8px;
        padding: 15px;
        margin-top: 20px;
        margin-bottom: 10px;
        color: #f1c40f;
        font-family: var(--font-ui);
        text-align: center;
        animation: fadeIn 1s;
        }

        .password-text {
        font-size: 1.5rem;
        font-weight: bold;
        margin-top: 5px;
        letter-spacing: 0.2em;
        text-shadow: 0 0 10px #f1c40f;
        }

    /* =========================================
       Animations
       ========================================= */
    
        /* æ¨™é¡Œå½ˆå‡º */
        @keyframes popIn {
        0% { transform: scale(0); opacity: 0; }
        60% { transform: scale(1.2); opacity: 1; }
        100% { transform: scale(1); opacity: 1; }
        }

        /* Boss åœ–ç‰‡ Zoom Out é€²å ´ */
        @keyframes bossZoomEntry {
            0% {
            transform: scale(5); /* è¶…å¤§ */
            opacity: 0;
            }
            20% {
            opacity: 0.2;
            }
            100% {
            transform: scale(1); /* æ­£å¸¸ */
            opacity: 1;
            }
        }

        /* æ‡‰ç”¨å‹•ç•«çš„ class */
        .anim-pop-in {
        animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .anim-boss-entry {
        animation: bossZoomEntry 1.5s ease-out forwards;
        }
    
        /* éš±è—å…ƒç´  (ç”¨æ–¼å‹•ç•«æµç¨‹) */
        .hidden-el {
        opacity: 0; 
        visibility: hidden;
        transition: opacity 0.5s;
        }
        .visible-el {
        opacity: 1;
        visibility: visible;
        }

        
        /* =========================================
           Question Area
           ========================================= */
        .kanji-display {
            text-align: center;
            font-size: 3.5rem;
            margin: 30px 0;
            font-weight: bold;
            letter-spacing: 0.05em;
            position: relative;
            min-height: 80px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .hint-overlay {
            font-size: 1.5rem;
            color: var(--highlight);
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            font-family: var(--font-ui);
            width: 100%;
            white-space: nowrap;
            text-shadow: 1px 1px 0 #000;
        }
        
        /* Red Answer Style (Answer revealed) */
        .hint-answer {
            color: var(--danger) !important;
            font-weight: bold;
            font-size: 1.6rem;
        }

        .info-box {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border: 1px solid #555;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .meaning {
            font-size: 1.1rem;
            color: var(--highlight);
            margin-bottom: 10px;
            font-weight: bold;
        }

        .example-sentence {
            font-size: 1.1rem;
            margin-bottom: 5px;
            line-height: 1.5;
        }

        .highlight-word {
            color: var(--highlight);
            text-decoration: underline;
            font-weight: bold;
        }

        .trans-sentence {
            font-size: 0.9rem;
            color: var(--text-sub);
        }

        /* =========================================
           Input Area & Virtual Keyboard
           ========================================= */
        .input-area {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .input-wrapper {
            position: relative;
            width: 100%;
        }

        input[type="text"] {
            background: #000;
            border: 2px solid var(--border-color);
            color: white;
            font-size: 1.3rem;
            padding: 10px;
            text-align: center;
            font-family: var(--font-main);
            border-radius: 4px;
            ime-mode: disabled; 
            width: 100%;
            box-sizing: border-box;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--highlight);
        }

        input:disabled {
            background: #222;
            color: #aaa;
            border-color: #444;
        }

        /* Overlay for Ghost Text */
        #virtual-input-display {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: none;
            justify-content: center;
            align-items: center;
            font-size: 1.3rem;
            font-family: var(--font-main);
            color: white;
            background: transparent;
        }

        input.virtual-active {
            color: transparent !important;
            caret-color: transparent;
            background: #111;
        }

        .ghost-text { color: #666; }

        .keyboard-switch {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 5px;
            font-family: var(--font-ui);
            font-size: 0.8rem;
        }
        .switch-label { margin-right: 10px; cursor: pointer; display: flex; align-items: center; }
        .switch-input { margin-right: 5px; }

        /* Virtual Keyboard */
        #virtual-keyboard {
            display: none;
            margin-top: 15px;
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 5px;
            user-select: none;
        }

        .key-row { display: flex; justify-content: center; margin-bottom: 5px; gap: 4px; }

        .key-btn {
            background: var(--key-bg);
            border: 1px solid #777;
            color: white;
            font-family: monospace;
            font-size: 1.2rem;
            width: 32px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 4px;
            cursor: pointer;
            box-shadow: 0 2px 0 #222;
        }
        .key-btn:active { transform: translateY(2px); box-shadow: none; }
        .key-btn.wide { width: 45px; font-size: 0.9rem; }

        /* Buttons */
        .btn-group { display: flex; gap: 10px; }

        button {
            background: var(--box-bg);
            border: 2px solid var(--border-color);
            color: white;
            padding: 10px;
            font-family: var(--font-ui);
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
            font-size: 1rem;
            touch-action: manipulation;
        }

        button:hover {
            background: var(--highlight);
            color: var(--bg-color);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .next-btn {
            background: var(--danger);
            display: none;
            margin-top: 10px;
            font-weight: bold;
            animation: pulse 1s infinite;
        }

        .return-btn {
            position: absolute;
            bottom: 20px;
            left: 20px;
            font-size: 0.8rem;
            padding: 5px 15px;
            width: auto;
            flex: none;
            background: #444;
            border-color: #888;
        }

        .hint-cost { display: block; font-size: 0.7em; margin-top: 2px; color: var(--danger); }

        /* =========================================
           Stage Select & Results
           ========================================= */
        .screen-overlay {
            display: none; 
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 100;
            overflow-y: auto;
            padding: 20px;
            box-sizing: border-box;
            padding-bottom: 50px;
        }

        .result-content {
            max-width: 800px;
            margin: 0 auto;
            color: white;
            text-align: center;
        }

        .title-logo {
            font-size: 3rem;
            margin-bottom: 20px;
            text-shadow: 2px 2px var(--highlight);
        }

        #stage-select-screen .title-logo {
            font-size: 2rem;
        }

        .stage-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
            width: 100%;
        }

        .stage-btn {
            background-color: #333;
            border: 2px solid #fff;
            padding: 20px;
            font-family: var(--font-ui);
            font-size: 1.2rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 30px;
            text-shadow: 2px 2px 4px #000;
            position: relative;
        }

        .stage-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px var(--highlight);
            z-index: 10;
        }
        
        .stage-desc {
            font-size: 0.8rem;
            margin-top: 5px;
            color: #eee;
            text-shadow: 1px 1px 2px #000;
        }

        .result-item {
            background: var(--box-bg);
            border: 1px solid #555;
            padding: 10px;
            margin-bottom: 10px;
            text-align: left;
            display: grid;
            grid-template-columns: 30px 1fr;
            gap: 10px;
        }
        .mark { font-size: 1.5rem; font-weight: bold; }
        .mark.correct { color: var(--hp-color); }
        .mark.wrong { color: var(--danger); }
        .review-details p { margin: 2px 0; }
        .correct-ans { color: var(--hp-color); font-weight: bold; }
        .your-ans { color: var(--danger); text-decoration: line-through; }

        #message-area {
            text-align: center;
            min-height: 1.5em;
            margin-top: 10px;
            font-weight: bold;
            font-size: 1.1em;
            white-space: pre-wrap;
            text-shadow: 1px 1px 2px black;
        }

        /* Animations */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .shake-anim { animation: shake 0.5s; border-color: var(--danger); }
        
        .flash-green { animation: flashGreen 0.5s; }
        @keyframes flashGreen {
            0% { box-shadow: 0 0 0px var(--hp-color); }
            50% { box-shadow: 0 0 30px var(--hp-color); }
            100% { box-shadow: 0 0 0px var(--hp-color); }
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes flashRed { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    </style>
</head>
<body>
    <!-- Background Layer for transitions -->
    <div id="background-layer"></div>

    <!-- Start Screen -->
    <div id="start-screen" class="screen-overlay" style="display: flex;">
        <div class="result-content">
            <h1 class="title-logo">N2æ¼¢å­—å‹‡è€…</h1>
            <p style="margin-bottom: 5px;">æ—¥æœ¬èªã®æ¼¢å­—èª­ã¿RPGã€€beta</p>
            <button onclick="goToStageSelect()" style="font-size: 1.5rem; padding: 20px 50px; margin-top: 0;">å†’é™ºã‚’å§‹ã‚ã‚‹</button>
            
            <div class="start-credits">
                åˆ¶ã€€ä½œï¼š<a href="https://linktr.ee/Xotarios/" style="color:#c6f2ff;">Xotarios</a>ï¼ˆç¬¬ä¸€æ—¥èªä½•å…ˆç”Ÿï¼‰+ AIå”åŠ›<br>
                éŸ³ã€€æ¥½ï¼š<a href="https://amachamusic.chagasi.com/index.html" style="color:#c6f2ff;">ç”˜èŒ¶ã®éŸ³æ¥½å·¥æˆ¿</a> & <a href="https://youfulca.com/" style="color:#c6f2ff;">ãƒ¦ãƒ¼ãƒ•ãƒ«ã‚«</a><br>
                åŠ¹æœéŸ³ï¼š<a href="https://soundeffect-lab.info/" style="color:#c6f2ff;">åŠ¹æœéŸ³ãƒ©ãƒœ</a>
            </div>
        </div>
    </div>

    <!-- Stage Select Screen -->
    <div id="stage-select-screen" class="screen-overlay">
        <div class="result-content">
            <h2 class="title-logo">è¡Œãå…ˆã‚’é¸æŠã›ã‚ˆ</h2>
            <p>å„ã‚¨ãƒªã‚¢ã«ã¯ç•°ãªã‚‹è¨€è‘‰ãŒå¾…ã¡å—ã‘ã¦ã„ã‚‹â€¦</p>
            <div id="stage-container" class="stage-grid">
                <!-- Buttons generated by JS -->
            </div>
            <button onclick="backToTitle()" style="margin-top: 30px; background: #555;">æˆ»ã‚‹</button>
            <div style="margin-top: 20px; padding-top: 10px; border-top: 1px solid #444;">
                <label style="color: #666; font-size: 0.8rem; cursor: pointer;">
                    <input type="checkbox" id="debug-toggle" onchange="toggleDebugMode()"> Debug Mode
                </label>
            </div>
        </div>
    </div>

    <!-- Main Game Screen -->
    <div class="game-container" id="game-screen" style="display:none;">
        <div class="header">
            <div class="header-left">
                <div>æ­£è§£æ•°: <span id="level-display">0</span> / <span id="total-display">20</span></div>
                <div id="stage-name-display" class="stage-name-small"></div>
            </div>
            <div class="hp-container">
                <div class="hp-bar" id="hp-bar"></div>
                <div class="hp-text">HP: <span id="hp-val">120</span></div>
            </div>
        </div>

        <!-- Boss UI -->
        <div id="boss-section">
            <div class="boss-image-container">
                <img src="" class="boss-img" id="boss-img">
            </div>
            <div class="boss-hp-bar-container">
                <div class="boss-hp-bar" id="boss-hp-bar"></div>
            </div>
            <div class="boss-timer">æ®‹ã‚Šæ™‚é–“ï¼š<span id="boss-timer-val">45</span> ç§’</div>
        </div>
        
        <div class="kanji-display">
            <div id="hint-display" class="hint-overlay"></div>
            <span id="kanji-text"></span>
        </div>

        <div class="info-box">
            <div class="meaning" id="meaning-text"></div>
            <div class="example-sentence" id="sentence-text"></div>
            <div class="trans-sentence">ï¼ˆ<span id="trans-text"></span>ï¼‰</div>
        </div>

        <!-- Input Mode Switch -->
        <div class="keyboard-switch">
            <label class="switch-label">
                <input type="checkbox" id="vk-toggle" class="switch-input" checked onchange="toggleInputMode()">
                ä»®æƒ³ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚’ä½¿ç”¨ï¼ˆæ¨å¥¨ï¼‰
            </label>
        </div>

        <div class="input-area">
            <div class="input-wrapper">
                <input type="text" id="answer-input" 
                    placeholder="èª­ã¿æ–¹ï¼ˆé€ã‚Šä»®åå«ã‚€ï¼‰" 
                    autocomplete="off" 
                    autocorrect="off" 
                    autocapitalize="off" 
                    spellcheck="false"
                    enterkeyhint="done">
                
                <!-- Overlay for Virtual Keyboard -->
                <div id="virtual-input-display"></div>
            </div>
                   
            <div class="btn-group">
                <button onclick="checkAnswer()" id="submit-btn">æ±ºå®š</button>
                <button onclick="useHint()" id="hint-btn">ãƒ’ãƒ³ãƒˆ <span class="hint-cost">-5 HP</span></button>
            </div>
            <button onclick="manualNext()" id="next-btn" class="next-btn">æ¬¡ã¸é€²ã‚€</button>
        </div>
        
        <!-- Virtual Keyboard (QWERTY) -->
        <div id="virtual-keyboard">
            <div class="key-row">
                <div class="key-btn" onclick="vkPress('q')">q</div>
                <div class="key-btn" onclick="vkPress('w')">w</div>
                <div class="key-btn" onclick="vkPress('e')">e</div>
                <div class="key-btn" onclick="vkPress('r')">r</div>
                <div class="key-btn" onclick="vkPress('t')">t</div>
                <div class="key-btn" onclick="vkPress('y')">y</div>
                <div class="key-btn" onclick="vkPress('u')">u</div>
                <div class="key-btn" onclick="vkPress('i')">i</div>
                <div class="key-btn" onclick="vkPress('o')">o</div>
                <div class="key-btn" onclick="vkPress('p')">p</div>
            </div>
            <div class="key-row">
                <div class="key-btn" onclick="vkPress('a')">a</div>
                <div class="key-btn" onclick="vkPress('s')">s</div>
                <div class="key-btn" onclick="vkPress('d')">d</div>
                <div class="key-btn" onclick="vkPress('f')">f</div>
                <div class="key-btn" onclick="vkPress('g')">g</div>
                <div class="key-btn" onclick="vkPress('h')">h</div>
                <div class="key-btn" onclick="vkPress('j')">j</div>
                <div class="key-btn" onclick="vkPress('k')">k</div>
                <div class="key-btn" onclick="vkPress('l')">l</div>
            </div>
            <div class="key-row">
                <div class="key-btn" onclick="vkPress('z')">z</div>
                <div class="key-btn" onclick="vkPress('x')">x</div>
                <div class="key-btn" onclick="vkPress('c')">c</div>
                <div class="key-btn" onclick="vkPress('v')">v</div>
                <div class="key-btn" onclick="vkPress('b')">b</div>
                <div class="key-btn" onclick="vkPress('n')">n</div>
                <div class="key-btn" onclick="vkPress('m')">m</div>
                <div class="key-btn wide" onclick="vkPress('bs')">âŒ«</div>
            </div>
        </div>

        <div id="message-area"></div>

        <!-- In-game Return Button -->
        <button onclick="goToStageSelect()" class="return-btn">â—€ è«¦ã‚ã‚‹</button>
    </div>

    <!-- Result Screen -->
    <div id="result-screen" class="screen-overlay">
        <div class="result-content">
            <h1 id="result-title"></h1>
            <div id="result-boss-area" style="display:none;">
                <div class="boss-display-container">
                    <div class="boss-text-style boss-title-label" id="result-boss-title"></div>
                    
                    <img id="result-boss-img" src="" style="width:120px; height:120px; object-fit:contain; filter: drop-shadow(0 0 10px #fff);">
                    
                    <div class="boss-text-style boss-name-label">
                        <span class="boss-name-ruby" id="result-boss-kana"></span>
                        <span id="result-boss-name"></span>
                    </div>
                </div>
                <!-- çµæœå°è©±æ¡† -->
                <div class="boss-dialogue" id="result-dialogue"></div>
            </div>
            
            <p id="result-msg"></p>

            <div id="review-list" style="margin-top: 20px;"></div>

            <div id="password-reward-container" class="password-reward-box" style="display:none;">
                <div style="font-size:0.9rem;">çµ‚ç„‰ã®åŸã€€å…¥åŸæš—å·ç²å¾—ï¼š</div>
                <div id="password-reward-text" class="password-text"></div>
            </div>

            <button onclick="goToStageSelect()" style="margin-top: 20px; padding: 15px 30px;">åˆ¥ã®ã‚¨ãƒªã‚¢ã¸</button>
        </div>
    </div>
    <!-- â˜…â˜…â˜… æ–°å¢ï¼šBoss é€²å ´ Overlay â˜…â˜…â˜… -->
    <div id="boss-overlay">
        <!-- 1. æ¨™é¡Œ -->
        <div class="boss-intro-banner hidden-el" id="intro-banner">
            <div class="boss-intro-title">ãƒœã‚¹ãŒç¾ã‚Œã¾ã—ãŸ</div>
        </div>

        <!-- 2. Boss é¡¯ç¤ºå€ (èº«åˆ† - åœ–ç‰‡ - åå­—) -->
        <div class="boss-display-container hidden-el" id="intro-boss-container">
            <!-- å·¦ï¼šèº«åˆ† -->
            <div class="boss-text-style boss-title-label" id="intro-boss-title">TITLE</div>
            
            <!-- ä¸­ï¼šåœ–ç‰‡ -->
            <div class="boss-intro-img-container">
                <img src="" id="intro-boss-img" class="boss-intro-img">
            </div>
            
            <!-- å³ï¼šåå­— -->
            <div class="boss-text-style boss-name-label">
                <span class="boss-name-ruby" id="intro-boss-kana">kana</span>
                <span id="intro-boss-name">NAME</span>
            </div>
        </div>

        <!-- 3. å°è©±æ¡† -->
        <div class="boss-dialogue hidden-el" id="intro-dialogue"></div>

        <!-- 4. ä»»å‹™èªªæ˜èˆ‡æŒ‰éˆ• -->
        <div class="hidden-el" id="intro-controls" style="text-align:center; width:100%;">
            <div class="boss-intro-desc" id="boss-intro-text">
                åˆ¶é™æ™‚é–“40ç§’ä»¥å†…ã«5å•æ­£è§£ã›ã‚ˆï¼
            </div>
            <button class="boss-start-btn" onclick="startActualBossBattle()">ã‹ã‹ã£ã¦ã“ã„ï¼</button>
        </div>

    <div id="boss-section">
        <div class="boss-display-container">
                <div class="boss-text-style boss-title-label" id="battle-boss-title" style="font-size:1rem;"></div>
                
                <div class="boss-image-container">
                    <img src="" class="boss-img" id="boss-img">
                </div>
                
                <div class="boss-text-style boss-name-label" style="font-size:1rem;">
                    <span class="boss-name-ruby" id="battle-boss-kana"></span>
                    <span id="battle-boss-name"></span>
                </div>
            </div>
            
            <div class="boss-hp-bar-container">
                <div class="boss-hp-bar" id="boss-hp-bar"></div>
            </div>
            <div class="boss-timer">TIME: <span id="boss-timer-val">45</span></div>
    </div>
    <audio id="bgm-player" loop preload="auto"></audio>

<script>
    // ==========================================
    // Stage & Word Data
    // ==========================================

let stageData = null; 
let currentQ = null;
const DATA_URL = "https://raw.githubusercontent.com/xotarios/N2-kanji-yuusha/refs/heads/main/questions.json";
//const DATA_URL = "/questions.json"; //

document.addEventListener('click', function(e) {
        // æª¢æŸ¥é»æ“Šçš„å…ƒç´ æ˜¯å¦ç‚º Button æˆ–è€…æ˜¯ .stage-btn (é—œå¡é¸æ“‡éˆ•)
        const target = e.target;
        
        if (target.closest('.stage-btn')) {
            playSE('btn');
            return;
        }

        if (target.tagName === 'BUTTON' && !target.classList.contains('key-btn')) {
            
            // â˜…â˜…â˜… ä¿®æ”¹ï¼šæ±ºå®šæŒ‰éˆ• (submit-btn) ä¸æ’­éŸ³æ•ˆ â˜…â˜…â˜…
            if (target.id === 'submit-btn') {
                return; 
            }

            // â˜…â˜…â˜… ä¿®æ”¹ï¼šæç¤ºæŒ‰éˆ• (hint-btn) æ’­ Wrong éŸ³æ•ˆ â˜…â˜…â˜…
            if (target.id === 'hint-btn') {
                playSE('wrong');
                return;
            }

            // å…¶ä»–æŒ‰éˆ• (å¦‚ï¼šStart, Back, Restart) æ’­æ™®é€šéŸ³æ•ˆ
            playSE('btn');
        }
    });

    // ==========================================
    // Romaji to Hiragana Table (Updated)
    // ==========================================
    const kanaTable = {
        'a':'ã‚','i':'ã„','u':'ã†','e':'ãˆ','o':'ãŠ',
        'ka':'ã‹','ki':'ã','ku':'ã','ke':'ã‘','ko':'ã“',
        'sa':'ã•','si':'ã—','shi':'ã—','su':'ã™','se':'ã›','so':'ã',
        'ta':'ãŸ','ti':'ã¡','chi':'ã¡','tu':'ã¤','tsu':'ã¤','te':'ã¦','to':'ã¨',
        'na':'ãª','ni':'ã«','nu':'ã¬','ne':'ã­','no':'ã®',
        'ha':'ã¯','hi':'ã²','hu':'ãµ','fu':'ãµ','he':'ã¸','ho':'ã»',
        'ma':'ã¾','mi':'ã¿','mu':'ã‚€','me':'ã‚','mo':'ã‚‚',
        'ya':'ã‚„','yi':'ã„','yu':'ã‚†','ye':'ã„ã‡','yo':'ã‚ˆ',
        'ra':'ã‚‰','ri':'ã‚Š','ru':'ã‚‹','re':'ã‚Œ','ro':'ã‚',
        'wa':'ã‚','wo':'ã‚’','nn':'ã‚“',
        'ga':'ãŒ','gi':'ã','gu':'ã','ge':'ã’','go':'ã”',
        'za':'ã–','zi':'ã˜','ji':'ã˜','zu':'ãš','ze':'ãœ','zo':'ã',
        'da':'ã ','di':'ã¢','du':'ã¥','de':'ã§','do':'ã©',
        'ba':'ã°','bi':'ã³','bu':'ã¶','be':'ã¹','bo':'ã¼',
        'pa':'ã±','pi':'ã´','pu':'ã·','pe':'ãº','po':'ã½',
        'vu':'ã‚”',
        'xtu':'ã£','xtsu':'ã£','ltu':'ã£','ltsu':'ã£', 
        'kya':'ãã‚ƒ','kyu':'ãã‚…','kyo':'ãã‚‡',
        'sha':'ã—ã‚ƒ','shu':'ã—ã‚…','sho':'ã—ã‚‡','sya':'ã—ã‚ƒ','syu':'ã—ã‚…','syo':'ã—ã‚‡',
        'cha':'ã¡ã‚ƒ','chu':'ã¡ã‚…','cho':'ã¡ã‚‡','tya':'ã¡ã‚ƒ','tyu':'ã¡ã‚…','tyo':'ã¡ã‚‡',
        'nya':'ã«ã‚ƒ','nyu':'ã«ã‚…','nyo':'ã«ã‚‡',
        'hya':'ã²ã‚ƒ','hyu':'ã²ã‚…','hyo':'ã²ã‚‡',
        'mya':'ã¿ã‚ƒ','myu':'ã¿ã‚…','myo':'ã¿ã‚‡',
        'rya':'ã‚Šã‚ƒ','ryu':'ã‚Šã‚…','ryo':'ã‚Šã‚‡',
        'gya':'ãã‚ƒ','gyu':'ãã‚…','gyo':'ãã‚‡',
        'ja':'ã˜ã‚ƒ','ju':'ã˜ã‚…','jo':'ã˜ã‚‡','jya':'ã˜ã‚ƒ','jyu':'ã˜ã‚…','jyo':'ã˜ã‚‡',
        'bya':'ã³ã‚ƒ','byu':'ã³ã‚…','byo':'ã³ã‚‡',
        'pya':'ã´ã‚ƒ','pyu':'ã´ã‚…','pyo':'ã´ã‚‡',
        'xya':'ã‚ƒ','xyu':'ã‚…','xyo':'ã‚‡','lya':'ã‚ƒ','lyu':'ã‚…','lyo':'ã‚‡',
        '-':'ãƒ¼'
    };

    // ==========================================
    // Game State & Variables
    // ==========================================
    let hp = 120;
    const MAX_HP = 120;
    let currentQuestions = [];
    let currentIndex = 0;
    let correctCount = 0;
    let hintLevel = 0; 
    let gameHistory = []; 
    let mistakeCount = 0; 
    let isVirtualKeyboard = true; 
    let romajiBuffer = ""; 
    let currentStageId = null; //ç”¨ä¾†å„²å­˜ã€Œç•¶å‰é¡¯ç¤ºçš„é¡Œç›®ç‰©ä»¶ã€
    
    // Boss State
    let isBossBattle = false;
    let bossHP = 100;
    let maxBossHP = 100;
    let bossTimer = 45;
    let bossInterval = null;
    let bossDefeatedAt = -1;

    // Boss & Demon Castle Logic
    let isDemonCastleMode = false; // æ˜¯å¦ç‚ºé­”ç‹åŸæ¨¡å¼
    let demonCastleProgress = 0;   // é­”ç‹åŸé€²åº¦ (0-50)
    let activeBossData = null;     // ç•¶å‰ Boss çš„è³‡æ–™ (ç”¨æ–¼éš¨æ©ŸæŠ½å– Mid-Boss)
    let usedBossKeys = [];         // å·²ä½¿ç”¨éçš„ Boss Key (é¿å…é‡è¤‡å‡ºç¾)
    let isFinalBoss = false;       // æ˜¯å¦ç‚ºæœ€çµ‚é­”ç‹
    let bossQuestionCount = 0;     // ç•¶å‰ Boss æˆ°å·²å‡ºé¡Œæ•¸ (ç”¨æ–¼åˆ¤æ–·é ­2é¡Œ)
    let currentBossQuestionPool = [];

    let isDebugMode = false; // æ–°å¢ Debug ç‹€æ…‹è®Šæ•¸

    const PASS_COST = 5;

    // ==========================================
    // DOM Elements
    // ==========================================
    const body = document.body;
    const bgLayer = document.getElementById('background-layer');
    const hpBar = document.getElementById('hp-bar');
    const hpVal = document.getElementById('hp-val');
    const levelDisp = document.getElementById('level-display');
    const totalDisp = document.getElementById('total-display');
    const stageNameDisp = document.getElementById('stage-name-display'); // å°å­— Stage Name
    const kanjiText = document.getElementById('kanji-text');
    const hintDisp = document.getElementById('hint-display');
    const meaningText = document.getElementById('meaning-text');
    const sentenceText = document.getElementById('sentence-text');
    const transText = document.getElementById('trans-text');
    const answerInput = document.getElementById('answer-input');
    const virtualDisplay = document.getElementById('virtual-input-display');
    const hintBtn = document.getElementById('hint-btn');
    const msgArea = document.getElementById('message-area');
    const gameContainer = document.querySelector('.game-container');
    const nextBtn = document.getElementById('next-btn');
    const submitBtn = document.getElementById('submit-btn');
    const vkDiv = document.getElementById('virtual-keyboard');
    const vkToggle = document.getElementById('vk-toggle');
    const startScreen = document.getElementById('start-screen');
    const stageScreen = document.getElementById('stage-select-screen');
    const gameScreen = document.getElementById('game-screen');
    const resultScreen = document.getElementById('result-screen');
    const stageContainer = document.getElementById('stage-container');
    const bossSection = document.getElementById('boss-section');
    const bossHpBar = document.getElementById('boss-hp-bar');
    const bossTimerVal = document.getElementById('boss-timer-val');
    const bossImgElement = document.getElementById('boss-img');
    const bossOverlay = document.getElementById('boss-overlay');
    const introBossImg = document.getElementById('intro-boss-img');
    const bossIntroText = document.getElementById('boss-intro-text');

    const BGM_FILES = {
        menu: "https://github.com/xotarios/N2-kanji-yuusha/raw/refs/heads/main/bgm/natsuyasuminotanken.mp3", 
        boss: "https://github.com/xotarios/N2-kanji-yuusha/raw/refs/heads/main/bgm/norainutonoranekonokousou.mp3",
        finalBoss: "https://github.com/xotarios/N2-kanji-yuusha/raw/refs/heads/main/bgm/odysseia.mp3"
    };

    const SE_FILES = {
        btn: "https://github.com/xotarios/N2-kanji-yuusha/raw/refs/heads/main/se/%E6%B1%BA%E5%AE%9A%E3%83%9C%E3%82%BF%E3%83%B3%E3%82%92%E6%8A%BC%E3%81%9923.mp3",
        correct: "https://github.com/xotarios/N2-kanji-yuusha/raw/refs/heads/main/se/%E6%B1%BA%E5%AE%9A%E3%83%9C%E3%82%BF%E3%83%B3%E3%82%92%E6%8A%BC%E3%81%9947.mp3",
        wrong: "https://github.com/xotarios/N2-kanji-yuusha/raw/refs/heads/main/se/%E5%B0%8F%E3%83%91%E3%83%B3%E3%83%81.mp3",
        boss_hit: "https://github.com/xotarios/N2-kanji-yuusha/raw/refs/heads/main/se/%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%E5%91%BD%E4%B8%AD.mp3",
        timer: "https://github.com/xotarios/N2-kanji-yuusha/raw/refs/heads/main/se/beep5.mp3",
        warning: "https://github.com/xotarios/N2-kanji-yuusha/raw/refs/heads/main/se/teki_unit.mp3"
    };

    const bgmPlayer = document.getElementById('bgm-player');
    bgmPlayer.volume = 0.4; // è¨­å®šéŸ³é‡ (0.0 - 1.0)

    function playBGM(url) {
        if (!url) return;
        
        // å¦‚æœå·²ç¶“åœ¨æ’­åŒä¸€é¦–ï¼Œå°±ä¸è¦é‡é ­æ’­
        // æ³¨æ„ï¼šæœ‰äº› CDN URL å¯èƒ½æœƒè®Šï¼Œé€™è£¡åšç°¡å–®åˆ¤æ–·
        if (bgmPlayer.src === url && !bgmPlayer.paused) return;

        bgmPlayer.src = url;
        bgmPlayer.play().catch(e => console.log("BGM Autoplay blocked:", e));
    }

    function playSE(key) {
        if (!SE_FILES[key]) return;
        
        // æ¯æ¬¡å»ºç«‹æ–°çš„ Audio ç‰©ä»¶ï¼Œç¢ºä¿å¯ä»¥é‡ç–Šæ’­æ”¾ï¼ˆä¾‹å¦‚é€£æŒ‰æŒ‰éˆ•ï¼‰
        const audio = new Audio(SE_FILES[key]);
        audio.volume = 0.8; // éŸ³æ•ˆéŸ³é‡
        audio.play().catch(e => {}); // å¿½ç•¥è‡ªå‹•æ’­æ”¾é™åˆ¶éŒ¯èª¤
    }

    // ==========================================
    // Scene Management
    // ==========================================
    function goToStageSelect() {
        playBGM(BGM_FILES.menu);
        startScreen.style.display = 'none';
        resultScreen.style.display = 'none';
        gameScreen.style.display = 'none';
        stageScreen.style.display = 'flex';
        
        // é‡ç½®èƒŒæ™¯å±¤
        document.body.classList.remove('stage-entering');
        bgLayer.style.backgroundImage = 'none';
        if (!stageData) {
            loadStageData();
        } else {
            renderStageButtons();
        }
    }

    function backToTitle() {
        playBGM(BGM_FILES.menu);
        stageScreen.style.display = 'none';
        startScreen.style.display = 'flex';
    }

    function renderStageButtons() {
        stageContainer.innerHTML = "";
        for (const [key, data] of Object.entries(stageData)) {
            const btn = document.createElement('div');
            btn.className = 'stage-btn';
            
            // Set Background with dimming
            btn.style.background = `linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('${data.img}')`;
            btn.style.backgroundSize = "cover"; 
            btn.style.backgroundPosition = "center";

            btn.innerHTML = `<div>${data.name}</div><div class="stage-desc">${data.desc}</div>`;
            btn.onclick = () => initGame(key);
            stageContainer.appendChild(btn);
        }
    }

    function toggleDebugMode() {
        isDebugMode = document.getElementById('debug-toggle').checked;
        console.log("Debug Mode:", isDebugMode ? "ON" : "OFF");
    }

    // ==========================================
    // Game Initialization
    // ==========================================
    async function initGame(stageKey) {
        if (stageKey === 'demon_castle') {
            const password = prompt("å…¥åŸæš—å·ï¼ˆå„ã‚¨ãƒªã‚¢ã®ãƒœã‚¹ã‚’æ’ƒç ´ã—ãŸã‚‰è²°ãˆã¾ã™ã€‚ã²ã‚‰ãŒãªã§å…¥åŠ›ï¼‰");
            if (!password) return; 
            
            const inputHash = await sha256(password);
            const correctHash = "38d7a13a71896294f0650098eb57d0724bdce53346016a68c9b8fd4e2e9a4c16"; 

            if (inputHash !== correctHash) {
                alert("å…¥åŸæš—å·ãŒé•ã„ã¾ã™ã€‚");
                return;
            }
            
            isDemonCastleMode = true;
            demonCastleProgress = 0;
        } else {
            isDemonCastleMode = false;
        }

        currentStageId = stageKey;
        const stage = stageData[stageKey];

        if (stage.bgm) {
            playBGM(stage.bgm);
        }

        // 1. è¨­å®šèƒŒæ™¯å±¤ (ç¨ç«‹å±¤)
        bgLayer.style.backgroundImage = `url('${stage.img}')`;
        document.body.classList.remove('stage-entering'); // Reset animation class
        // 2. è¨­å®š Game Container (è®Šæš—æ¿¾é¡)
        gameContainer.style.background = `linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('${stage.img}')`;
        gameContainer.style.backgroundSize = "cover";
        gameContainer.style.backgroundPosition = "center";

        // Setup Game Logic
        hp = 120;
        updateHP(0);
        currentIndex = 0;
        correctCount = 0;
        demonCastleProgress = 0;
        gameHistory = [];
        isBossBattle = false;
        isFinalBoss = false;
        activeBossData = null;
        bossDefeatedAt = -1;
        usedBossKeys = [];
        clearInterval(bossInterval);
        bossSection.style.display = 'none';

        let targetCount;
        if (isDemonCastleMode) {
            targetCount = isDebugMode ? 10 : 50; // Debug:10, Normal:50
        } else {
            targetCount = isDebugMode ? 3 : 20;  // Debug:3, Normal:20
        }
        totalDisp.innerText = targetCount;
        levelDisp.innerText = 0;
        
        // UI Info
        stageNameDisp.innerText = `ğŸš© ${stage.name}`;

        // â˜…â˜…â˜… é¡Œåº«æº–å‚™ â˜…â˜…â˜…
        if (isDemonCastleMode) {
            // é­”ç‹åŸï¼šå°‡æ‰€æœ‰å…¶ä»– Stage çš„ words åˆä½µ
            let allWords = [];
            for (const key in stageData) {
                if (key !== 'demon_castle' && stageData[key].words) {
                    allWords = allWords.concat(stageData[key].words);
                }
            }
            if (allWords.length === 0) { alert("ãƒ‡ãƒ¼ã‚¿ä¸è¶³"); return; }
            currentQuestions = allWords.sort(() => 0.5 - Math.random());
            // é­”ç‹åŸä¸è¨­ currentIndex é™åˆ¶ï¼Œå› ç‚ºæˆ‘å€‘æœƒä¸æ–·éš¨æ©ŸæŠ½
            currentIndex = 0; 
        } else {
            // æ™®é€šé—œå¡
            let source = stage.words;
            if(!source || source.length === 0) { alert("No Data"); return; }
            currentQuestions = [...source].sort(() => 0.5 - Math.random());
            currentIndex = 0;
        }
        
        // 3. åŸ·è¡Œéå ´å‹•ç•« (Transition)
        stageScreen.style.display = 'none';
        document.body.classList.add('stage-entering'); // Trigger CSS scale/dim animation
        
        // å»¶é²é¡¯ç¤ºéŠæˆ²ç•«é¢
        setTimeout(() => {
            gameScreen.style.display = 'block';
            toggleInputMode();
            loadQuestion();
        }, 1500);
    }

    // ==========================================
    // Question Loading Logic
    // ==========================================
    function loadQuestion() {
        // æ¯æ¬¡åŠ è¼‰å•é¡Œæ™‚ï¼Œå›å¾© GameContainer çš„èƒŒæ™¯ (ç§»é™¤ç¶ è‰²ï¼Œè®Šå›é»‘è‰²æ¿¾é¡)
        if (currentStageId && stageData[currentStageId]) {
            const imgUrl = stageData[currentStageId].img;
            gameContainer.style.background = `linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('${imgUrl}')`;
            gameContainer.style.backgroundSize = "cover";
            gameContainer.style.backgroundPosition = "center";
        }

        // åˆ¤æ–·æ˜¯å¦é€²å…¥ Boss æˆ°
        if (!isBossBattle) {
            // è¨­å®šç›®æ¨™æ•¸å€¼ (Debug vs Normal)
            const normalBossTarget = isDebugMode ? 3 : 20;       // æ™®é€šé—œå¡: 3é¡Œ vs 20é¡Œ
            const dcBossInterval = isDebugMode ? 2 : 10;         // é­”ç‹åŸé–“éš”: 2é¡Œ vs 10é¡Œ
            const dcFinalTarget = isDebugMode ? 10 : 50;         // é­”ç‹åŸFinal: 10é¡Œ vs 50é¡Œ

            if (isDemonCastleMode) {
                // é­”ç‹åŸé‚è¼¯
                if (demonCastleProgress > 0 && demonCastleProgress % dcBossInterval === 0) {
                    // â˜…â˜…â˜… é—œéµä¿®æ­£ï¼šæª¢æŸ¥é€™å€‹é€²åº¦çš„ Boss æ˜¯å¦å·²ç¶“æ‰“è´é â˜…â˜…â˜…
                    if (demonCastleProgress !== bossDefeatedAt) {
                        // å¦‚æœé”åˆ° Final ç›®æ¨™
                        if (demonCastleProgress === dcFinalTarget) {
                            triggerBossIntro(true);
                        } else {
                            triggerBossIntro(false);
                        }
                        return; 
                    }
                }
            } else {
                // æ™®é€šé—œå¡é‚è¼¯
                if (correctCount >= normalBossTarget) {
                    triggerBossIntro(false);
                    return;
                }
            }
        } else {
            // Boss æˆ°ä¸­ï¼šæª¢æŸ¥ Boss HP
            if (bossHP <= 0) {
                handleBossVictory();
                return;
            }
        }

        // Game Over & End Checks
        if (hp <= 0) {
            clearInterval(bossInterval);
            endGame(false);
            return;
        }
        
        // æ™®é€šæ¨¡å¼é¡Œåº«ç”¨å®Œ
        if (!isDemonCastleMode && !isBossBattle && currentIndex >= currentQuestions.length) {
            if (isDemonCastleMode) {
                 // é‡æ–°ç”Ÿæˆé¡Œåº« (å¾ stageData å†æŠ“ä¸€æ¬¡)
                 let allWords = [];
                 for (const key in stageData) {
                     if (key !== 'demon_castle' && stageData[key].words) {
                         allWords = allWords.concat(stageData[key].words);
                     }
                 }
                 currentQuestions = allWords.sort(() => 0.5 - Math.random());
             } else {
                 // æ™®é€šæ¨¡å¼é¡Œåº«ç”¨å®Œ = å‹åˆ©
                 endGame(true);
                 return;
             }
        }

        if (isBossBattle) {
            currentQ = getBossQuestion();
        } else {
            // æ™®é€šé¡Œç›®
            if (isDemonCastleMode) {
                // â˜…â˜…â˜… é­”ç‹åŸä¿®æ­£ï¼šä½¿ç”¨ã€ŒæŠ½ç‰Œã€æ–¹å¼ (å–å‡ºä¸¦ç§»é™¤)ï¼Œç¢ºä¿ä¸é‡è¤‡ â˜…â˜…â˜…
                // shift() æœƒå–å‡ºé™£åˆ—ç¬¬ä¸€å€‹å…ƒç´ ï¼Œä¸¦å°‡å…¶å¾é™£åˆ—ä¸­åˆªé™¤
                if (currentQuestions.length > 0) {
                    currentQ = currentQuestions.shift();
                } else {
                    // è¬ä¸€çœŸçš„ç©ºäº† (ç†è«–ä¸Šä¸Šé¢æœ‰ refill é‚è¼¯ï¼Œé€™è£¡åšä¿éšª)
                    endGame(true); return; 
                }
            } else {
                // æ™®é€šé—œå¡ï¼šä¾åºå‡ºé¡Œ (currentIndex æœƒåœ¨ç­”å°æ™‚ +1)
                // é€™è£¡æª¢æŸ¥æ˜¯å¦è¶…å‡ºç¯„åœ
                if (currentIndex < currentQuestions.length) {
                    currentQ = currentQuestions[currentIndex];
                } else {
                    endGame(true); return;
                }
            }
        }
        const displayQ = currentQ; // ç”¨æ–¼é¡¯ç¤º

        // UI
        levelDisp.innerText = isDemonCastleMode ? demonCastleProgress : correctCount;
        let targetCount;
        if (isDemonCastleMode) {
            targetCount = isDebugMode ? 10 : 50;
        } else {
            targetCount = isDebugMode ? 3 : 20;
        }
        totalDisp.innerText = targetCount;
        kanjiText.innerText = displayQ.kanji;
        meaningText.innerText = "ã€æ„å‘³ã€‘" + displayQ.meaning;
        sentenceText.innerHTML = "ã€ä¾‹å¥ã€‘" + displayQ.sentence;
        transText.innerText = displayQ.trans;
        
        // Input Reset
        answerInput.value = "";
        answerInput.disabled = false;
        romajiBuffer = "";
        updateVirtualDisplay();
        msgArea.innerText = "";
        nextBtn.style.display = "none";
        
        // Hint Reset
        hintLevel = 0;
        mistakeCount = 0;
        hintDisp.innerText = "";
        hintDisp.classList.remove("hint-answer");
        
        hintBtn.disabled = false;
        if (isBossBattle && isFinalBoss) {
            hintBtn.innerHTML = 'ãƒ’ãƒ³ãƒˆ'; 
        } else {
             hintBtn.innerHTML = 'ãƒ’ãƒ³ãƒˆ1ï¼ˆä»®åã®æ•°ï¼‰ <span class="hint-cost">-5 HP</span>';
        }
        submitBtn.disabled = false;
        submitBtn.style.display = "block";
    }

    function triggerBossIntro(isFinal) {
        isFinalBoss = isFinal;
        
        // è¨­å®š Boss è³‡æ–™
        if (isDemonCastleMode) {
            if (isFinal) {
                activeBossData = stageData['demon_castle']; 
            } else {
                // â˜…â˜…â˜… ä¿®æ”¹ï¼šMid Boss é˜²é‡è¤‡é‚è¼¯ â˜…â˜…â˜…
                // 1. å–å¾—æ‰€æœ‰å¯ç”¨çš„é—œå¡ Key (æ’é™¤é­”ç‹åŸæœ¬èº«)
                const allKeys = Object.keys(stageData).filter(k => k !== 'demon_castle');
                
                // 2. ç¯©é¸å‡ºã€Œé‚„æ²’æ‰“éã€çš„ Key
                let availableKeys = allKeys.filter(k => !usedBossKeys.includes(k));
                
                // 3. å¦‚æœæ‰€æœ‰ Boss éƒ½æ‰“éäº†ï¼ˆä¾‹å¦‚ Debug æ¨¡å¼é »ç¹å‡º Bossï¼‰ï¼Œå‰‡é‡ç½®æ¸…å–®ï¼Œé‡æ–°å¾ªç’°
                if (availableKeys.length === 0) {
                    usedBossKeys = [];
                    availableKeys = allKeys;
                }
                
                // 4. éš¨æ©ŸæŠ½ä¸€å€‹
                const randomKey = availableKeys[Math.floor(Math.random() * availableKeys.length)];
                
                // 5. è¨˜éŒ„èµ·ä¾†
                usedBossKeys.push(randomKey);
                
                activeBossData = stageData[randomKey];
                // â˜…â˜…â˜… ä¿®æ”¹çµæŸ â˜…â˜…â˜…
            }
        } else {
            activeBossData = stageData[currentStageId];
        }

        // è¨­å®š Overlay å…§å®¹
        document.getElementById('intro-boss-title').innerText = activeBossData.bossTitle || "BOSS";
        document.getElementById('intro-boss-name').innerText = activeBossData.bossName || "???";
        document.getElementById('intro-boss-kana').innerText = activeBossData.bossNameKana || "";
        introBossImg.src = activeBossData.bossImg || "https://cdn-icons-png.flaticon.com/512/1998/1998610.png";
        
        if (isFinal) {
            bossIntroText.innerHTML = "FINAL BOSSå‡ºç¾ï¼<br>åˆ¶é™æ™‚é–“80ç§’ - 10å•æ­£è§£ã›ã‚ˆï¼<br><span style='color:red; font-size:0.8em;'>â€»ãƒ’ãƒ³ãƒˆä½¿ç”¨ä¸å¯ãƒ»ãƒŸã‚¹å¤§ãƒ€ãƒ¡ãƒ¼ã‚¸</span>";
            // â˜…â˜…â˜… æ–°å¢ï¼šåœ¨æ­¤è™•æ’­æ”¾ Final Boss BGM â˜…â˜…â˜…
            playBGM(BGM_FILES.finalBoss);
        } else {
            bossIntroText.innerHTML = "ãƒœã‚¹ãŒç¾ã‚Œã¾ã—ãŸï¼<br>åˆ¶é™æ™‚é–“45ç§’ - 5å•æ­£è§£ã›ã‚ˆï¼";
            // â˜…â˜…â˜… æ–°å¢ï¼šåœ¨æ­¤è™•æ’­æ”¾ Boss BGM â˜…â˜…â˜…
            playBGM(BGM_FILES.boss);
        }

        // 3. é‡ç½®å‹•ç•«ç‹€æ…‹ (éš±è—æ‰€æœ‰å…ƒç´ )
        const banner = document.getElementById('intro-banner');
        const container = document.getElementById('intro-boss-container');
        const img = document.getElementById('intro-boss-img');
        const dialogue = document.getElementById('intro-dialogue');
        const controls = document.getElementById('intro-controls');

        banner.className = "boss-intro-banner hidden-el";
        container.className = "boss-display-container hidden-el";
        img.className = "boss-intro-img"; // é‡ç½® zoom class
        dialogue.className = "boss-dialogue hidden-el";
        controls.className = "hidden-el";
        dialogue.innerHTML = ""; // æ¸…ç©ºå°ç™½


        // é¡¯ç¤º Overlay
        bossOverlay.style.display = 'flex';

        // 4. é–‹å§‹å‹•ç•«åºåˆ—
        setTimeout(async () => {
            // Step 1: æ¨™é¡Œå½ˆå‡º + è­¦å ±è²
            playSE('warning');
            banner.classList.remove('hidden-el');
            banner.classList.add('anim-pop-in');

            await new Promise(r => setTimeout(r, 800));

            // Step 2: Boss åœ–ç‰‡ Zoom Out é€²å ´ + é¡¯ç¤ºåå­—
            container.classList.remove('hidden-el');
            img.classList.add('anim-boss-entry'); // åœ–ç‰‡ç¸®æ”¾å‹•ç•«

            await new Promise(r => setTimeout(r, 1500)); // ç­‰åœ–ç‰‡å®šæ ¼
            
            // Step 3: é¡¯ç¤ºå°è©±æ¡†ä¸¦æ‰“å­—
            dialogue.classList.remove('hidden-el');
            let introText = activeBossData.dialogueIntro || "......";
            if (isDemonCastleMode && !isFinal) {
                if (activeBossData.dialogueDemonCastleIntro) {
                    introText = activeBossData.dialogueDemonCastleIntro;
                }
            }
            await typeWriter(introText, 'intro-dialogue', 30); // æ‰“å­—é€Ÿåº¦

            // Step 4: é¡¯ç¤ºæŒ‰éˆ•
            controls.classList.remove('hidden-el');
            controls.classList.add('visible-el');

        }, 100);
    }

    function startActualBossBattle() {
        bossOverlay.style.display = 'none';
        bossSection.style.display = 'flex';
        
        isBossBattle = true;

        bossQuestionCount = 0; // é‡ç½®å‡ºé¡Œæ•¸

        // æº–å‚™ Boss é¡Œåº«æ± 
        currentBossQuestionPool = []; // æ¸…ç©º

        if (isFinalBoss) {
            // Final Boss: é›†åˆæ‰€æœ‰é—œå¡çš„ Boss é¡Œç›®
            for (const key in stageData) {
                if (stageData[key].bossWords) {
                    // è¤‡è£½é¡Œç›®é€²æ± å­
                    currentBossQuestionPool = currentBossQuestionPool.concat(stageData[key].bossWords);
                }
            }
        } else {
            // æ™®é€š Boss: åªç”¨è©²é—œå¡ Boss é¡Œç›®
            if (activeBossData.bossWords) {
                // è¤‡è£½é¡Œç›®é€²æ± å­ (ä½¿ç”¨ [...array] è¤‡è£½ï¼Œé¿å…å½±éŸ¿åŸè³‡æ–™)
                currentBossQuestionPool = [...activeBossData.bossWords];
            }
        }
        
        // è¨­å®šæ•¸å€¼
        if (isFinalBoss) {
            bossHP = 200; // éœ€ç­”å° 10 é¡Œ (200 / 20)
            maxBossHP = 200;
            bossTimer = 80;
        } else {
            bossHP = 100; // éœ€ç­”å° 5 é¡Œ (100 / 20)
            maxBossHP = 100;
            bossTimer = 45;
        }

        document.getElementById('battle-boss-title').innerText = activeBossData.bossTitle || "";
        document.getElementById('battle-boss-name').innerText = activeBossData.bossName || "";
        document.getElementById('battle-boss-kana').innerText = activeBossData.bossNameKana || "";
        bossImgElement.src = activeBossData.bossImg || "https://cdn-icons-png.flaticon.com/512/1998/1998610.png";
        bossHpBar.style.width = "100%";
        bossTimerVal.innerText = bossTimer;

        const timerContainer = document.querySelector('.boss-timer');
        timerContainer.classList.remove('critical');
        timerContainer.classList.remove('shake-anim');
        
        // å•Ÿå‹•è¨ˆæ™‚
        clearInterval(bossInterval);
        bossInterval = setInterval(() => {
            bossTimer--;
            bossTimerVal.innerText = bossTimer;
            if (bossTimer <= 10 && bossTimer > 0) {
                // 1. æ’­æ”¾éŸ³æ•ˆ
                playSE('timer');
                
                // 2. è®Šç´…è®Šå¤§
                timerContainer.classList.add('critical');
                
                // 3. æ™ƒå‹•å‹•ç•« (åˆ©ç”¨ CSS Reflow é‡ç½®å‹•ç•«)
                timerContainer.classList.remove('shake-anim');
                void timerContainer.offsetWidth; // Trigger Reflow
                timerContainer.classList.add('shake-anim');
            }

            if (bossTimer <= 0) {
                clearInterval(bossInterval);
                if (bossHP > 0) endGame(false);
            }
        }, 1000);
        
        loadQuestion();
    }

    function getBossQuestion() {
        bossQuestionCount++;
        
        // Final Boss: å¾æ‰€æœ‰ Boss é¡Œåº«ä¸­éš¨æ©ŸæŠ½
        if (isFinalBoss) {
            let allBossWords = [];
            for (const key in stageData) {
                if (stageData[key].bossWords) {
                    allBossWords = allBossWords.concat(stageData[key].bossWords);
                }
            }
            if(allBossWords.length > 0) {
                return allBossWords[Math.floor(Math.random() * allBossWords.length)];
            }
            // Fallback if no boss words
            return currentQuestions[Math.floor(Math.random() * currentQuestions.length)];
        }
        
        // æ™®é€š Boss / Mid Boss
        // ç¬¬ 1-2 é¡Œï¼šæ™®é€šé¡Œåº«
        if (bossQuestionCount <= 2) {
            if (isDemonCastleMode) {
                 const originWords = activeBossData.words;
                 
                 // éæ¿¾æ‰å·²ç¶“åœ¨ gameHistory å‡ºç¾éçš„é¡Œç›®
                 // æ‰¾å‡ºã€Œé‚„æ²’ç­”éã€çš„è©²é—œå¡é¡Œç›®
                 const availableWords = originWords.filter(w => 
                     !gameHistory.some(history => history.kanji === w.kanji && history.reading === w.reading)
                 );

                 if (availableWords.length > 0) {
                     // å¾æ²’ç­”éçš„é¡Œç›®ä¸­éš¨æ©ŸæŠ½
                     return availableWords[Math.floor(Math.random() * availableWords.length)];
                 } else {
                     // å¦‚æœè©²é—œå¡æ‰€æœ‰æ™®é€šé¡Œç›®éƒ½ç­”éäº†ï¼Œå°±åªå¥½éš¨æ©ŸæŠ½
                     return originWords[Math.floor(Math.random() * originWords.length)];
                 }
            } else {
                 // æ™®é€šæ¨¡å¼ï¼šç¹¼çºŒæ²¿ç”¨ currentIndex é †åºï¼Œç¢ºä¿ä¸å›é ­
                 // å› ç‚º loadQuestion ç”¨ currentIndexï¼Œé€™è£¡ä¹Ÿç”¨ currentIndex
                 // æ³¨æ„ï¼šhandleCorrectAnswer æœƒ +1ï¼Œæ‰€ä»¥é€™è£¡ç›´æ¥æ‹¿ç”±å®ƒç¹¼çºŒ
                 if (currentIndex < currentQuestions.length) {
                     return currentQuestions[currentIndex];
                 } else {
                     // è¬ä¸€é¡Œç›®ä¸å¤  (ä¾‹å¦‚ Debug æ¨¡å¼é¡Œç›®å°‘)ï¼Œå›å‚³æœ€å¾Œä¸€é¡Œæˆ–éš¨æ©Ÿ
                     return currentQuestions[Math.floor(Math.random() * currentQuestions.length)];
                 }
            }
        } 
        // ç¬¬ 3 é¡Œä»¥å¾Œï¼šBoss å°ˆå±¬é¡Œåº« (å¾æ± ä¸­ç§»é™¤é‚è¼¯ï¼Œä¿æŒä¸è®Š)
        else {
            if (currentBossQuestionPool.length === 0) {
                if (activeBossData.bossWords) currentBossQuestionPool = [...activeBossData.bossWords];
                if (currentBossQuestionPool.length === 0) return currentQuestions[0]; // Fallback
            }
            const randomIndex = Math.floor(Math.random() * currentBossQuestionPool.length);
            const q = currentBossQuestionPool[randomIndex];
            currentBossQuestionPool.splice(randomIndex, 1);
            return q;
        }
    
        // éš¨æ©Ÿé¸ä¸€å€‹ index
        const randomIndex = Math.floor(Math.random() * currentBossQuestionPool.length);
            
            // å–å‡ºé¡Œç›®
        const q = currentBossQuestionPool[randomIndex];
            
            // â˜… é—œéµï¼šå¾æ± å­ä¸­ç§»é™¤é€™é¡Œï¼Œé¿å…é‡è¤‡ â˜…
        currentBossQuestionPool.splice(randomIndex, 1);
            
        return q;

    }


    function handleBossVictory() {
        clearInterval(bossInterval);
        isBossBattle = false;
        //bossSection.style.display = 'none';//
        const defaultDefeatedImg = "https://cdn-icons-png.flaticon.com/512/8890/8890786.png";
        if (activeBossData && activeBossData.bossDefeatedImg) {
            bossImgElement.src = activeBossData.bossDefeatedImg;
        } else {
            bossImgElement.src = defaultDefeatedImg;
        }
        
        if (isDemonCastleMode) {
            if (isFinalBoss) {
                // ç‚ºäº†è®“ç©å®¶çœ‹åˆ° Final Boss çš„æˆ°æ•—åœ–ï¼Œå»¶é²ä¸€é»æ‰è·³è½‰
                setTimeout(() => {
                    endGame(true);
                }, 2000);
            } else {
                bossDefeatedAt = demonCastleProgress;

                if (stageData[currentStageId].bgm) {
                    playBGM(stageData[currentStageId].bgm);
                }

                updateHP(20); 
                msgArea.style.color = "#f1c40f";
                msgArea.innerText = "ãƒœã‚¹æ’ƒç ´ï¼HP +20 å›å¾©ï¼";
                
                setTimeout(() => {
                    bossSection.style.display = 'none'; 
                    loadQuestion();
                }, 2000);
            }
        } else {
            // æ™®é€šé—œå¡ï¼šå»¶é²å¾Œé€šé—œ
            setTimeout(() => {
                endGame(true);
            }, 2000);
        }
    }

     // â˜…â˜…â˜…è² è²¬ä¸‹è¼‰ JSON â˜…â˜…â˜…
    async function loadStageData() {
        const container = document.getElementById('stage-container');
        // é¡¯ç¤ºè¼‰å…¥ä¸­æ–‡å­—
        container.innerHTML = '<div style="color:white; text-align:center; margin-top:50px; font-family:var(--font-ui);">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...<br>(Loading...)</div>';

        try {
            const response = await fetch(DATA_URL);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            stageData = await response.json(); // å°‡ä¸‹è¼‰åˆ°çš„è³‡æ–™æ”¾å…¥ stageData
            renderStageButtons(); // è³‡æ–™åˆ°äº†ï¼Œç”¢ç”ŸæŒ‰éˆ•
        } catch (error) {
            console.error("Error loading stage data:", error);
            container.innerHTML = '<div style="color:#e74c3c; text-align:center; margin-top:50px;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>';
        }
    }

    async function sha256(message) {
        const msgBuffer = new TextEncoder().encode(message);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // ==========================================
    // Boss Battle Logic
    // ==========================================
    function startBossBattle() {
        isBossBattle = true;
        bossHP = 100;
        bossTimer = 45;
        
        // Boss Image
        const stage = stageData[currentStageId];
        bossImgElement.src = stage.bossImg || "https://cdn-icons-png.flaticon.com/512/1998/1998610.png"; 
        
        // UI Show
        bossSection.style.display = 'flex';
        bossHpBar.style.width = "100%";
        bossTimerVal.innerText = bossTimer;
        
        // Timer Start
        clearInterval(bossInterval);
        bossInterval = setInterval(() => {
            bossTimer--;
            bossTimerVal.innerText = bossTimer;
            
            if (bossTimer <= 0) {
                clearInterval(bossInterval);
                if (bossHP > 0) {
                    endGame(false); // Time over
                }
            }
        }, 1000);
        
        // Continue loading questions
        loadQuestion();
    }

    function updateHP(change) {
        hp += change;
        if (hp > MAX_HP) hp = MAX_HP;
        if (hp < 0) hp = 0;
        
        const pct = (hp / MAX_HP) * 100;
        hpBar.style.width = pct + "%";
        hpVal.innerText = hp;
        
        if (pct > 50) hpBar.style.background = "#2ecc71";
        else if (pct > 20) hpBar.style.background = "#f1c40f";
        else hpBar.style.background = "#e74c3c";

        if (change < 0) {
            gameContainer.classList.add('shake-anim');
            setTimeout(() => gameContainer.classList.remove('shake-anim'), 500);
        } else if (change > 0) {
            gameContainer.classList.add('flash-green');
            setTimeout(() => gameContainer.classList.remove('flash-green'), 500);
        }

        if (hp <= 0) {
            setTimeout(() => endGame(false), 1000);
        }
    }

    // ==========================================
    // Input & Keyboard Logic
    // ==========================================
    function toggleInputMode() {
        isVirtualKeyboard = vkToggle.checked;
        if (isVirtualKeyboard) {
            vkDiv.style.display = "block";
            answerInput.classList.add("virtual-active");
            answerInput.readOnly = true; 
            virtualDisplay.style.display = "flex";
            updateVirtualDisplay();
            answerInput.blur();
        } else {
            vkDiv.style.display = "none";
            answerInput.classList.remove("virtual-active");
            answerInput.readOnly = false;
            virtualDisplay.style.display = "none";
        }
    }

    function updateVirtualDisplay() {
        let ghost = "";
        if (isVirtualKeyboard && romajiBuffer.length > 0) {
            ghost = `<span class="ghost-text">${romajiBuffer}</span>`;
        }
        virtualDisplay.innerHTML = answerInput.value + ghost;
    }

    function vkPress(key) {
        if (navigator.vibrate) {
            navigator.vibrate(15);
        }
        if (answerInput.disabled) return;

        if (key === 'bs') {
            if (romajiBuffer.length > 0) {
                romajiBuffer = romajiBuffer.slice(0, -1);
            } else {
                answerInput.value = answerInput.value.slice(0, -1);
            }
        } else {
            romajiBuffer += key;
            
            if (kanaTable[romajiBuffer]) {
                answerInput.value += kanaTable[romajiBuffer];
                romajiBuffer = "";
            } else {
                // Special n handling
                if (romajiBuffer.length >= 2 && romajiBuffer[0] === 'n' && !['y','a','i','u','e','o'].includes(romajiBuffer[1])) {
                    if (romajiBuffer[1] === 'n') {
                        answerInput.value += 'ã‚“';
                        romajiBuffer = "";
                    } else {
                        answerInput.value += 'ã‚“';
                        romajiBuffer = romajiBuffer.substring(1);
                        if (kanaTable[romajiBuffer]) {
                             answerInput.value += kanaTable[romajiBuffer];
                             romajiBuffer = "";
                        }
                    }
                }
                // Small tsu handling
                if (romajiBuffer.length >= 2 && romajiBuffer[0] === romajiBuffer[1] && !['a','i','u','e','o','n'].includes(romajiBuffer[0])) {
                    answerInput.value += 'ã£';
                    romajiBuffer = romajiBuffer.substring(1);
                }
                // Flush if too long
                if (romajiBuffer.length > 3) {
                    answerInput.value += romajiBuffer[0];
                    romajiBuffer = romajiBuffer.substring(1);
                }
            }
        }
        updateVirtualDisplay();
    }

    // ==========================================
    // Hint & Answer Checking
    // ==========================================
    function useHint() {
        if (isFinalBoss) {
            msgArea.style.color = "#e74c3c";
            msgArea.innerText = "ä½œè€…ã®å¨åœ§ã§ãƒ’ãƒ³ãƒˆãŒä½¿ãˆãªã„ï¼";
            return; // ç¦æ­¢ä½¿ç”¨
        }

        const q = currentQ;
        
        if (hintLevel === 0) {
            updateHP(-5);
            hintLevel = 1;
            mistakeCount = 1;
            hintDisp.innerText = q.hint1;
            hintBtn.innerHTML = `ãƒ’ãƒ³ãƒˆ2ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ã‹ãªè¡¨ç¤ºï¼‰ <span class="hint-cost">-5 HP</span>`;
        } else if (hintLevel === 1) {
            updateHP(-5);
            hintLevel = 2;
            mistakeCount = 2; 
            hintDisp.innerText = generateRandomHint(q);
            hintBtn.innerHTML = `ãƒ‘ã‚¹ <span class="hint-cost">-${PASS_COST} HP</span>`;
        } else if (hintLevel === 2) {
            triggerPass(q);
        }
    }

    function triggerPass(q) {
        updateHP(-PASS_COST);
        let correctR = Array.isArray(q.reading) ? q.reading[0] : q.reading;
        
        gameHistory.push({
            ...q,
            userAns: "ãƒ‘ã‚¹",
            isCorrect: false,
            correctAnswer: correctR
        });
        
        // Show Pass in Input
        answerInput.value = "ãƒ‘ã‚¹ã—ã¾ã—ãŸ";
        romajiBuffer = "";
        updateVirtualDisplay();
        answerInput.disabled = true;
        
        // Show Answer Red
        hintDisp.innerHTML = `æ­£è§£ï¼š${correctR}`;
        hintDisp.classList.add("hint-answer");
        msgArea.innerText = ""; 
        
        onWrongAnswerState();
    }

    function checkAnswer() {
        const userVal = answerInput.value.trim();
        if (!userVal) return;

        const q = currentQ;

        let isCorrect = false;
        let correctPrimary = Array.isArray(q.reading) ? q.reading[0] : q.reading; // ç”¨æ–¼é¡¯ç¤ºç­”æ¡ˆ
        
        // Context strict check
        if (q.strict) {
            if (userVal === q.reading) isCorrect = true;
            else if (userVal === q.altReading) {
                 msgArea.style.color = "#e74c3c";
                 msgArea.innerText = `ä¸æ­£è§£ï¼æ–‡è„ˆãŒé•ã„ã¾ã™ã€‚\n${q.altExplain}`;
                 handleWrongAnswer(q, userVal, true); 
                 return;
            } else isCorrect = false;
        } else {
            if (Array.isArray(q.reading)) {
                if (q.reading.includes(userVal)) isCorrect = true;
            } else {
                if (userVal === q.reading) isCorrect = true;
            }
        }

        if (isCorrect) {
            handleCorrectAnswer(q, userVal);
        } else {
            // Final Boss æ‡²ç½°
            if (isFinalBoss) {
                updateHP(-15); // ç›´æ¥æ‰£ 15
                hintDisp.innerHTML = `æ­£è§£ï¼š${correctPrimary}`;
                hintDisp.classList.add("hint-answer");
                msgArea.style.color = "#e74c3c";
                msgArea.innerText = `ä¸æ­£è§£ï¼ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸï¼ã€`;
                // æ‰£è¡€ï¼Œç„¶å¾Œç•¶ä½œ MistakeCount 3 (ç›´æ¥è¼¸æ‰é€™é¡Œ)
                handleWrongAnswer(q, userVal, false, true); // true = force fail
            } else {
                handleWrongAnswer(q, userVal, false, false);
            }
        }
    }

    function handleCorrectAnswer(q, userVal) {
        updateHP(5);
        
        // Change Background Filter to Green
        if (currentStageId && stageData[currentStageId]) {
            const imgUrl = stageData[currentStageId].img;
            gameContainer.style.background = `linear-gradient(rgba(46, 204, 113, 0.6), rgba(46, 204, 113, 0.6)), url('${imgUrl}')`;
            gameContainer.style.backgroundSize = "cover";
            gameContainer.style.backgroundPosition = "center";
        }

        if (!isBossBattle) {
            if (isDemonCastleMode) {
                demonCastleProgress++;
                levelDisp.innerText = demonCastleProgress;
            } else {
                correctCount++;
                levelDisp.innerText = correctCount;
            }
        }
        
        msgArea.style.color = "#2ecc71";
        msgArea.innerText = "æ­£è§£ï¼";
        
        gameHistory.push({ ...q, userAns: userVal, isCorrect: true });
        
        // Boss Damage
        if (isBossBattle) {
            // Boss æˆ°ï¼šæ’­æ”¾å—å‚·éŸ³æ•ˆ
            playSE('boss_hit');
            
            bossHP -= 20; 
            if (bossHP < 0) bossHP = 0;
            
            const hpPercent = (bossHP / maxBossHP) * 100;
            bossHpBar.style.width = `${hpPercent}%`;
            
            // Flash effect
            bossImgElement.style.filter = "brightness(5) sepia(1) hue-rotate(-50deg) saturate(5)";
            setTimeout(() => {
                bossImgElement.style.filter = ""; 
            }, 200);
        } else {
            // ä¸€èˆ¬æˆ°ï¼šæ’­æ”¾æ­£ç¢ºéŸ³æ•ˆ
            playSE('correct');
        }

        submitBtn.disabled = true;
        hintBtn.disabled = true;
        
        setTimeout(() => {
            currentIndex++; // æ™®é€šæ¨¡å¼ä¸‹æœ‰ç”¨ï¼Œé­”ç‹åŸæ¨¡å¼ä¸‹ currentIndex é›–æœ‰å¢åŠ ä½† loadQuestion ä¸æœƒç”¨å®ƒ
            loadQuestion();
        }, 1000);
    }

    function handleWrongAnswer(q, userVal, isContextError, forceFail = false) {
        if (userVal || forceFail) {
            playSE('wrong');
        }
        
        let correctR = Array.isArray(q.reading) ? q.reading[0] : q.reading;
        
        if (forceFail) {
            mistakeCount = 2;
        }
        
        if (mistakeCount === 0) {
            // 1st Mistake
            updateHP(-5);
            mistakeCount = 1;
            hintLevel = 1;
            hintDisp.innerText = q.hint1;
            hintBtn.innerHTML = `ãƒ’ãƒ³ãƒˆ2ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ã‹ãªè¡¨ç¤ºï¼‰ <span class="hint-cost">-5 HP</span>`;
            if(!isContextError) {
                msgArea.style.color = "#e74c3c";
                msgArea.innerText = "ä¸æ­£è§£ã€‚ã‚‚ã†ä¸€åº¦ï¼";
            }
        } 
        else if (mistakeCount === 1) {
            // 2nd Mistake
            updateHP(-5);
            mistakeCount = 2;
            hintLevel = 2;
            hintDisp.innerText = generateRandomHint(q);
            hintBtn.innerHTML = `ãƒ‘ã‚¹ <span class="hint-cost">-${PASS_COST} HP</span>`;

            if(!isContextError) {
                msgArea.style.color = "#e74c3c";
                msgArea.innerText = "ä¸æ­£è§£ã€‚æœ€å¾Œã®ãƒãƒ£ãƒ³ã‚¹ï¼";
            }
        }
        else if (mistakeCount === 2) {
            // 3rd Mistake (Fail)
            if (!forceFail) {
                updateHP(-5);
            }
            
            hintDisp.innerHTML = `æ­£è§£ï¼š${correctR}`;
            hintDisp.classList.add("hint-answer");
            if (!forceFail) {
                msgArea.innerText = ""; 
            }

            answerInput.disabled = true;
            
            gameHistory.push({ 
                ...q, 
                userAns: userVal, 
                isCorrect: false,
                correctAnswer: correctR
            });
            onWrongAnswerState();
        }
    }

    function onWrongAnswerState() {
        answerInput.disabled = true;
        submitBtn.style.display = "none";
        hintBtn.disabled = true;
        nextBtn.style.display = "block";
    }

    function typeWriter(text, elementId, speed = 50) {
        const element = document.getElementById(elementId);
        element.innerHTML = "";
        let i = 0;
        
        return new Promise(resolve => {
            function type() {
                if (i < text.length) {
                    element.innerHTML += text.charAt(i);
                    i++;
                    setTimeout(type, speed);
                } else {
                    resolve(); // å®Œæˆ
                }
            }
            type();
        });
    }

    function manualNext() {
        currentIndex++;
        loadQuestion();
    }

    answerInput.addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            if(!submitBtn.disabled && submitBtn.style.display !== "none") {
                checkAnswer();
            } else if (nextBtn.style.display === "block") {
                manualNext();
            }
        }
    });

    function generateRandomHint(q) {
        // å–å¾—è®€éŸ³ (å¦‚æœæ˜¯å¤šè®€éŸ³é™£åˆ—ï¼Œå–ç¬¬ä¸€å€‹)
        const reading = Array.isArray(q.reading) ? q.reading[0] : q.reading;
        const hint1 = q.hint1;

        // 1. æ‰¾å‡ºæ‰€æœ‰è¢«éš±è— (â—) çš„ä½ç½® index
        let hiddenIndices = [];
        for (let i = 0; i < hint1.length; i++) {
            if (hint1[i] === 'â—') {
                hiddenIndices.push(i);
            }
        }

        const hiddenCount = hiddenIndices.length;

        // 2. æ ¹æ“šéš±è—æ•¸é‡æ±ºå®šè¦å…¬é–‹å¤šå°‘å€‹å­—
        // åªæœ‰ 1 å€‹ï¼šç„¡æ³•å†çµ¦æç¤º
        if (hiddenCount <= 1) {
            return "ï¼ˆã“ã‚Œä»¥ä¸Šãƒ’ãƒ³ãƒˆãŒå‡ºã›ãªã„ï¼‰";
        }

        let revealNum = 0;
        if (hiddenCount >= 2 && hiddenCount <= 4) {
            revealNum = 1;
        } else if (hiddenCount >= 5 && hiddenCount <= 7) {
            revealNum = 2;
        } else if (hiddenCount >= 8) {
            revealNum = 3;
        }

        // 3. éš¨æ©ŸæŠ½å‡ºè¦å…¬é–‹çš„ä½ç½®
        // æ´—ç‰Œ (Fisher-Yates ç°¡åŒ–ç‰ˆ)
        const shuffled = hiddenIndices.sort(() => 0.5 - Math.random());
        const selectedIndices = shuffled.slice(0, revealNum);

        // 4. çµ„åˆæ–°çš„ Hint å­—ä¸²
        let newHint = "";
        for (let i = 0; i < reading.length; i++) {
            if (selectedIndices.includes(i)) {
                // é€™æ˜¯è¢«é¸ä¸­è¦å…¬é–‹çš„å­—
                newHint += reading[i];
            } else if (hiddenIndices.includes(i)) {
                // é€™æ˜¯åŸæœ¬éš±è—ï¼Œä¸”æ²’è¢«é¸ä¸­çš„ -> ç¹¼çºŒéš±è—
                newHint += "â—";
            } else {
                // é€™æ˜¯åŸæœ¬å°±é¡¯ç¤ºçš„å­— (é€å‡å)
                newHint += reading[i];
            }
        }
        return newHint;
    }
    
function endGame(isWin) {
        clearInterval(bossInterval);
        document.body.classList.remove('stage-entering');
        
        gameScreen.style.display = 'none';
        resultScreen.style.display = 'flex';
        
        const title = document.getElementById('result-title');
        const msg = document.getElementById('result-msg');
        const list = document.getElementById('review-list');
        
        // Boss UI Elements
        const resultArea = document.getElementById('result-boss-area');
        const resultImg = document.getElementById('result-boss-img');
        const resultTitle = document.getElementById('result-boss-title');
        const resultName = document.getElementById('result-boss-name');
        const resultKana = document.getElementById('result-boss-kana');
        const resultDialogue = document.getElementById('result-dialogue');
        
        // Password UI Elements
        const passContainer = document.getElementById('password-reward-container');
        const passText = document.getElementById('password-reward-text');
        
        list.innerHTML = "";
        
        // â˜…â˜…â˜… é‡ç½®æ¨£å¼ (é è¨­ç‚ºé¡¯ç¤ºæ‰€æœ‰è³‡è¨Š) â˜…â˜…â˜…
        resultImg.classList.remove('boss-silhouette');
        resultDialogue.style.display = "block";
        resultTitle.style.display = "block";           // é‡ç½®æ¨™é¡Œé¡¯ç¤º
        resultName.parentElement.style.display = "block"; // é‡ç½®åå­—é¡¯ç¤º
        passContainer.style.display = "none";

        if (isWin) {
            title.innerText = "ğŸ‰ ã‚¨ãƒªã‚¢ã‚¯ãƒªã‚¢ï¼ ğŸ‰";
            title.style.color = "#2ecc71";
            msg.innerText = `è¦‹äº‹ã€${correctCount}å•æ­£è§£ã§ã€Œ${stageData[currentStageId].name}ã€ã‚’åˆ¶è¦‡ã—ã¾ã—ãŸï¼`;

            const bossData = activeBossData || stageData[currentStageId];

            if (bossData && bossData.bossDefeatedImg) {
                resultArea.style.display = "block";
                resultTitle.innerText = bossData.bossTitle || "";
                resultName.innerText = bossData.bossName || "";
                resultKana.innerText = bossData.bossNameKana || "";
                resultImg.src = bossData.bossDefeatedImg;
                resultDialogue.innerText = bossData.dialogueWin || "è¦‹äº‹ã â€¦ï¼";
            } else {
                resultArea.style.display = "none";
            }

            const currentStage = stageData[currentStageId];
            if (currentStage && currentStage.passwordHint) {
                passText.innerText = currentStage.passwordHint;
                passContainer.style.display = "block";
            }

        } else {
            title.innerText = "ğŸ’€ GAME OVER ğŸ’€";
            title.style.color = "#e74c3c";
            msg.innerText = `ã€Œ${stageData[currentStageId].name}ã€ã®æ¢ç´¢ã¯å¤±æ•—ã«çµ‚ã‚ã‚Šã¾ã—ãŸâ€¦ã€‚`;
            
            let displayBoss = activeBossData || stageData[currentStageId];

            if (displayBoss) {
                resultArea.style.display = "block";
                resultImg.src = displayBoss.bossImg; 

                // â˜…â˜…â˜… ä¿®æ”¹é‚è¼¯ï¼šåˆ¤æ–·æ˜¯å¦è¦‹é Boss â˜…â˜…â˜…
                if (!activeBossData) {
                    // Case 1: Boss æœªå‡ºç¾å°±è¼¸äº†
                    resultImg.classList.add('boss-silhouette'); // è®Šå‰ªå½±
                    
                    resultDialogue.style.display = "none";      // éš±è—å°ç™½
                    resultTitle.style.display = "none";         // éš±è—ç¨±è™Ÿ
                    resultName.parentElement.style.display = "none"; // éš±è—åå­— (é€£åŒä¸Šé¢çš„å‡å)
                } else {
                    // Case 2: Boss æˆ°ä¸­è¼¸äº† (æ­£å¸¸é¡¯ç¤º)
                    resultTitle.innerText = displayBoss.bossTitle || "";
                    resultName.innerText = displayBoss.bossName || "";
                    resultKana.innerText = displayBoss.bossNameKana || "";
                    resultDialogue.innerText = displayBoss.dialogueLose || "å‡ºç›´ã—ã¦ã“ã„ï¼";
                }
            } else {
                resultArea.style.display = "none";
            }
        }

        // ç”Ÿæˆå›é¡§åˆ—è¡¨
        gameHistory.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = 'result-item';
            
            const mark = item.isCorrect ? '<span class="mark correct">âœ”</span>' : '<span class="mark wrong">âœ–</span>';
            const ansDisplay = item.isCorrect 
                ? `<span class="correct-ans">${item.userAns}</span>` 
                : `<span class="your-ans">${item.userAns}</span> â†’ <span class="correct-ans">${item.correctAnswer}</span>`;

            div.innerHTML = `
                <div>${mark}</div>
                <div class="review-details">
                    <div style="font-size:1.2em; font-weight:bold;">${item.kanji}</div>
                    <div style="font-size:0.9em; color:#aaa;">${item.meaning}</div>
                    <div style="font-style:italic; margin: 5px 0;">${item.sentence}</div>
                    <div style="font-size:0.8em; color:#aaa;">ï¼ˆ${item.trans}ï¼‰</div>
                    <div style="margin-top:5px;">å›ç­”: ${ansDisplay}</div>
                </div>
            `;
            list.appendChild(div);
        });
        
        playBGM(BGM_FILES.menu);
    }
</script>
</body>
</html>
