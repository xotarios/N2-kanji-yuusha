<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>N2漢字勇者</title>
    <link href="https://fonts.googleapis.com/css2?family=Kaisei+Tokumin:wght@400;700&family=DotGothic16&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1a1c2c;
            --box-bg: rgba(41, 43, 65, 0.95);
            --border-color: #f4f4f4;
            --highlight: #f1c40f;
            --hp-color: #2ecc71;
            --danger: #e74c3c;
            --text-main: #ffffff;
            --text-sub: #bdc3c7;
            --font-main: 'Kaisei Tokumin', serif;
            --font-ui: 'DotGothic16', sans-serif;
            --key-bg: #4a4d66;
        }

        body {
            background-color: var(--bg-color);
            /* 背景圖交由 #background-layer 處理，這裡保持透明或底色 */
            color: var(--text-main);
            font-family: var(--font-main);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            overscroll-behavior: none;
            box-sizing: border-box;
        }

        /* 獨立背景層 (用於過場動畫放大變暗) */
        #background-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background-size: cover;
            background-position: center;
            transition: transform 2s ease-in-out, filter 2s ease-in-out;
        }

        /* 過場動畫狀態 */
        .stage-entering #background-layer {
            transform: scale(1.2);
            filter: brightness(0.4);
        }

        /* =========================================
           Start Screen Styling
           ========================================= */
        #start-screen {
            /* Title Background Image */
            background: url('https://raw.githubusercontent.com/xotarios/N2-kanji-yuusha/refs/heads/main/images/N2yuusha_2.png') no-repeat center top;
            background-size: cover;
            
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            
            /* 限制在手機寬度並置中 */
            position: fixed;
            top: 0;
            height: 100%;
            width: 100%;
            max-width: 600px;
            left: 50%;
            transform: translateX(-50%);
            
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            z-index: 2000;
        }

        /* Hide text title as image has it */
        #start-screen .title-logo {
            display: none;
        }

        /* Content positioning */
        #start-screen .result-content {
            padding-bottom: 5vh; /* 避開圖片標題 */
            max-width: 800px;
            margin: 0 auto;
            color: white;
            text-align: center;
            width: 90%;
        }

        .start-credits {
            margin-top: 30px;
            font-size: 0.8rem;
            color: #ddd;
            line-height: 1.6;
            font-family: var(--font-ui);
            text-shadow: 2px 2px 2px #000;
            background: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 8px;
            text-align: left;
            display: inline-block;
        }

        /* =========================================
           Game Container & Layout
           ========================================= */
        .game-container {
            width: 90%;
            max-width: 600px;
            background: var(--box-bg);
            border: 4px double var(--border-color);
            border-radius: 8px;
            padding: 20px;
            padding-bottom: 60px; /* Space for return button */
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            position: relative;
            backdrop-filter: blur(5px);
            /* 背景濾鏡變色由 JS 控制 (gameContainer.style.background) */
            transition: box-shadow 0.3s ease;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 25px;
            font-family: var(--font-ui);
        }

        .header-left {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .stage-name-small {
            font-size: 0.85rem;
            color: #aaa;
            font-weight: bold;
        }

        .hp-container {
            width: 50%;
            background: #000;
            border: 2px solid var(--border-color);
            height: 20px;
            position: relative;
            margin-top: 5px;
        }

        .hp-bar {
            height: 100%;
            background: var(--hp-color);
            width: 100%;
            transition: width 0.3s ease;
        }

        /* HP Text below bar */
        .hp-text {
            position: absolute;
            bottom: -22px;
            right: 0;
            font-size: 0.85em;
            color: var(--text-main);
            text-shadow: 1px 1px 0 #000;
            font-family: var(--font-ui);
        }

             
        #boss-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 3000;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        animation: fadeIn 0.5s;
        }

        .boss-intro-banner {
        width: 100%;
        background: linear-gradient(90deg, transparent, #870000, transparent);
        padding: 20px 0;
        text-align: center;
        color: #fff;
        font-family: var(--font-ui);
        border-top: 2px solid #ff0000;
        border-bottom: 2px solid #ff0000;
        margin-bottom: 20px;
            position: relative;
        }

        .boss-intro-title {
        font-size: 2rem;
        font-weight: bold;
        text-shadow: 0 0 10px #ff0000;
        margin-bottom: 10px;
        }

        .boss-intro-img-container {
        width: 150px;
        height: 150px;
        margin: 0 auto;
        filter: drop-shadow(0 0 15px rgba(255, 0, 0, 0.8));
        }
    
        .boss-intro-img {
        width: 100%; height: 100%; object-fit: contain;
        }

        .boss-intro-desc {
        font-size: 1.2rem;
        margin-top: 10px;
        color: #f1c40f;
        }

        .boss-start-btn {
        background: #e74c3c;
        border: 2px solid #fff;
        color: white;
        font-size: 1.5rem;
        font-family: var(--font-ui);
        cursor: pointer;
        transition: transform 0.2s;
        animation: pulse 1s infinite;
        display: flex;
        justify-content: center;
        align-items: center;
        width: fit-content;      /* 寬度隨文字縮放 */
        min-width: 200px;        /* 最小寬度 */
        height: 60px;            /* ★固定高度，解決太長問題★ */
        padding: 0 20px;         /* 左右留白 */
        margin: 20px auto 0;     /* 與上方橫條保持距離，並置中 */
        flex: none;              /* ★關鍵：防止被父容器拉伸★ */
    }
    
        .boss-start-btn:hover {
        transform: scale(1.1);
        background: #c0392b;
        }

        /* Boss Battle UI tweaks */
        #boss-section {
        display: none;
        flex-direction: column;
        align-items: center;
        margin-bottom: 10px;
        }

        .boss-image-container {
            position: relative;
            width: 120px;
            height: 120px;
            margin-bottom: 5px;
        }

        .boss-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 0 10px rgba(255,0,0,0.5));
            transition: filter 0.2s;
        }

        .boss-hp-bar-container {
            width: 80%;
            height: 15px;
            background: #333;
            border: 2px solid #fff;
            margin-bottom: 5px;
            position: relative;
        }

        .boss-hp-bar {
            width: 100%;
            height: 100%;
            background: #e74c3c;
            transition: width 0.3s ease;
        }

        .boss-timer {
            font-family: var(--font-ui);
            font-size: 1.5rem;
            color: #f1c40f;
            text-shadow: 2px 2px 0 #000;
        }

        .boss-display-container {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        margin-bottom: 10px;
        position: relative;
        }

        /* 粗獷字體樣式 */
         .boss-text-style {
        font-family: "Arial Black", "Impact", sans-serif; /* 粗體 */
        color: white;
        text-shadow: 3px 3px 0 #000, -1px -1px 0 #000;
        font-size: 1.5rem;
        font-weight: 900;
        letter-spacing: 0.1em;
        white-space: nowrap;
        }

        .boss-title-label {
        text-align: right;
        color: #f1c40f; /* 金色稱號 */
        transform: rotate(-5deg); /* 稍微傾斜增加動感 */
        }

        .boss-name-label {
        text-align: left;
        color: #e74c3c; /* 紅色名字 */
        transform: rotate(5deg);
        }

        .boss-name-ruby {
        display: block;
        font-size: 0.5em;
        color: #fff;
        text-shadow: 1px 1px 0 #000;
        margin-bottom: -5px;
        text-align: center;
        font-weight: normal;
        }

        /* Boss Dialogue Box */
        .boss-dialogue {
        background: rgba(0, 0, 0, 0.8);
        border: 2px solid #fff;
        border-radius: 8px;
        padding: 10px 15px;
        color: #fff;
        font-family: var(--font-ui);
        font-size: 1rem;
        min-height: 3.6em; /* 預留兩行空間 */
        width: 90%;
        max-width: 500px;
        margin: 10px auto;
        text-align: left;
        line-height: 1.6;
        box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        .boss-silhouette {
        /* 變全黑 + 白色外發光 */
        filter: brightness(0) drop-shadow(0 0 15px rgba(255, 255, 255, 0.9)) !important;
        opacity: 0.8;
        transition: filter 0.5s ease;
        }


        /* ★★★ 新增：密碼獎勵框樣式 ★★★ */
        .password-reward-box {
        background: rgba(241, 196, 15, 0.2); /* 金色半透明背景 */
        border: 2px solid #f1c40f;
        border-radius: 8px;
        padding: 15px;
        margin-top: 20px;
        margin-bottom: 10px;
        color: #f1c40f;
        font-family: var(--font-ui);
        text-align: center;
        animation: fadeIn 1s;
        }

        .password-text {
        font-size: 1.5rem;
        font-weight: bold;
        margin-top: 5px;
        letter-spacing: 0.2em;
        text-shadow: 0 0 10px #f1c40f;
        }

    /* =========================================
       Animations
       ========================================= */
    
        /* 標題彈出 */
        @keyframes popIn {
        0% { transform: scale(0); opacity: 0; }
        60% { transform: scale(1.2); opacity: 1; }
        100% { transform: scale(1); opacity: 1; }
        }

        /* Boss 圖片 Zoom Out 進場 */
        @keyframes bossZoomEntry {
            0% {
            transform: scale(5); /* 超大 */
            opacity: 0;
            }
            20% {
            opacity: 0.2;
            }
            100% {
            transform: scale(1); /* 正常 */
            opacity: 1;
            }
        }

        /* 應用動畫的 class */
        .anim-pop-in {
        animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .anim-boss-entry {
        animation: bossZoomEntry 1.5s ease-out forwards;
        }
    
        /* 隱藏元素 (用於動畫流程) */
        .hidden-el {
        opacity: 0; 
        visibility: hidden;
        transition: opacity 0.5s;
        }
        .visible-el {
        opacity: 1;
        visibility: visible;
        }

        
        /* =========================================
           Question Area
           ========================================= */
        .kanji-display {
            text-align: center;
            font-size: 3.5rem;
            margin: 30px 0;
            font-weight: bold;
            letter-spacing: 0.05em;
            position: relative;
            min-height: 80px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .hint-overlay {
            font-size: 1.5rem;
            color: var(--highlight);
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            font-family: var(--font-ui);
            width: 100%;
            white-space: nowrap;
            text-shadow: 1px 1px 0 #000;
        }
        
        /* Red Answer Style (Answer revealed) */
        .hint-answer {
            color: var(--danger) !important;
            font-weight: bold;
            font-size: 1.6rem;
        }

        .info-box {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border: 1px solid #555;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .meaning {
            font-size: 1.1rem;
            color: var(--highlight);
            margin-bottom: 10px;
            font-weight: bold;
        }

        .example-sentence {
            font-size: 1.1rem;
            margin-bottom: 5px;
            line-height: 1.5;
        }

        .highlight-word {
            color: var(--highlight);
            text-decoration: underline;
            font-weight: bold;
        }

        .trans-sentence {
            font-size: 0.9rem;
            color: var(--text-sub);
        }

        /* =========================================
           Input Area & Virtual Keyboard
           ========================================= */
        .input-area {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .input-wrapper {
            position: relative;
            width: 100%;
        }

        input[type="text"] {
            background: #000;
            border: 2px solid var(--border-color);
            color: white;
            font-size: 1.3rem;
            padding: 10px;
            text-align: center;
            font-family: var(--font-main);
            border-radius: 4px;
            ime-mode: disabled; 
            width: 100%;
            box-sizing: border-box;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--highlight);
        }

        input:disabled {
            background: #222;
            color: #aaa;
            border-color: #444;
        }

        /* Overlay for Ghost Text */
        #virtual-input-display {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: none;
            justify-content: center;
            align-items: center;
            font-size: 1.3rem;
            font-family: var(--font-main);
            color: white;
            background: transparent;
        }

        input.virtual-active {
            color: transparent !important;
            caret-color: transparent;
            background: #111;
        }

        .ghost-text { color: #666; }

        .keyboard-switch {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 5px;
            font-family: var(--font-ui);
            font-size: 0.8rem;
        }
        .switch-label { margin-right: 10px; cursor: pointer; display: flex; align-items: center; }
        .switch-input { margin-right: 5px; }

        /* Virtual Keyboard */
        #virtual-keyboard {
            display: none;
            margin-top: 15px;
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 5px;
            user-select: none;
        }

        .key-row { display: flex; justify-content: center; margin-bottom: 5px; gap: 4px; }

        .key-btn {
            background: var(--key-bg);
            border: 1px solid #777;
            color: white;
            font-family: monospace;
            font-size: 1.2rem;
            width: 32px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 4px;
            cursor: pointer;
            box-shadow: 0 2px 0 #222;
        }
        .key-btn:active { transform: translateY(2px); box-shadow: none; }
        .key-btn.wide { width: 45px; font-size: 0.9rem; }

        /* Buttons */
        .btn-group { display: flex; gap: 10px; }

        button {
            background: var(--box-bg);
            border: 2px solid var(--border-color);
            color: white;
            padding: 10px;
            font-family: var(--font-ui);
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
            font-size: 1rem;
            touch-action: manipulation;
        }

        button:hover {
            background: var(--highlight);
            color: var(--bg-color);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .next-btn {
            background: var(--danger);
            display: none;
            margin-top: 10px;
            font-weight: bold;
            animation: pulse 1s infinite;
        }

        .return-btn {
            position: absolute;
            bottom: 20px;
            left: 20px;
            font-size: 0.8rem;
            padding: 5px 15px;
            width: auto;
            flex: none;
            background: #444;
            border-color: #888;
        }

    /* =========================================
       Intro Video & Transitions
       ========================================= */
        #intro-video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover; /* 確保影片填滿畫面 */
        object-position: center top;
        z-index: -1;       /* 在文字下方，但在背景圖上方 */
        display: none;     /* 預設隱藏 */
        }

    /* Start Screen 變暗動畫 class */
    #start-screen.fading-out {
        transition: filter 1s linear; /* 1秒內變暗 */
        filter: brightness(0);        /* 變全黑 */
    }

    /* =========================================
       Loading Screen
       ========================================= */
        #loading-screen {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: #000;
        z-index: 5000;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: white;
        font-family: var(--font-ui);
        }

        .loading-text {
        font-size: 1.2rem;
        margin-bottom: 15px;
        letter-spacing: 0.1em;
        animation: pulse 1s infinite;
        }

        .progress-bar-bg {
        width: 80%;
        max-width: 400px;
        height: 10px;
        background: #333;
        border: 2px solid #555;
        border-radius: 5px;
        overflow: hidden;
        }

        .progress-bar-fill {
        height: 100%;
        background: var(--hp-color); /* 用綠色或金色 */
        width: 0%;
        /* ★★★ 1秒內由0去到100 ★★★ */
        transition: width 1s linear; 
        }

        .hint-cost { display: block; font-size: 0.7em; margin-top: 2px; color: var(--danger); }

        /* =========================================
           Stage Select & Results
           ========================================= */
        .screen-overlay {
            display: none; 
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 100;
            overflow-y: auto;
            padding: 20px;
            box-sizing: border-box;
            padding-bottom: 50px;
        }

        .result-content {
            max-width: 800px;
            margin: 0 auto;
            color: white;
            text-align: center;
        }

        .title-logo {
            font-size: 3rem;
            margin-bottom: 20px;
            text-shadow: 2px 2px var(--highlight);
        }

        #stage-select-screen {
        /* 1. 設定背景圖 (請換成您的地圖連結) + 半透明黑色濾鏡 */
        background: 
            linear-gradient(rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.3)),
            url('https://raw.githubusercontent.com/xotarios/N2-kanji-yuusha/refs/heads/main/images/menu_background.png')
            no-repeat center top;
        /* 2. 關鍵設定：讓背景隨著內容滾動 (local) */
        background-attachment: local;
        /* 3. 設定背景寬度100%，高度自動 (這樣捲到最底就會見到圖的最底) */
        background-size: cover;
        color: white;
        }
    
        /* 原本 .screen-overlay 設定了高透明度黑色，這裡要覆蓋掉，否則看不到圖 */
        #stage-select-screen.screen-overlay {
        background-color: transparent; 
        }

        #stage-select-screen .title-logo {
            font-size: 2rem;
        }

        .stage-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
            width: 100%;
        }

        .stage-btn {
            background-color: #333;
            border: 2px solid #fff;
            padding: 20px;
            font-family: var(--font-ui);
            font-size: 1.2rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 30px;
            text-shadow: 2px 2px 4px #000;
            position: relative;
        }

        .stage-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px var(--highlight);
            z-index: 10;
        }
        
        .stage-desc {
            font-size: 0.8rem;
            margin-top: 5px;
            color: #eee;
            text-shadow: 1px 1px 2px #000;
        }

        .result-item {
            background: var(--box-bg);
            border: 1px solid #555;
            padding: 10px;
            margin-bottom: 10px;
            text-align: left;
            display: grid;
            grid-template-columns: 30px 1fr;
            gap: 10px;
        }
        .mark { font-size: 1.5rem; font-weight: bold; }
        .mark.correct { color: var(--hp-color); }
        .mark.wrong { color: var(--danger); }
        .review-details p { margin: 2px 0; }
        .correct-ans { color: var(--hp-color); font-weight: bold; }
        .your-ans { color: var(--danger); text-decoration: line-through; }

        #message-area {
            text-align: center;
            min-height: 1.5em;
            margin-top: 10px;
            font-weight: bold;
            font-size: 1.1em;
            white-space: pre-wrap;
            text-shadow: 1px 1px 2px black;
        }

        /* Animations */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .shake-anim { animation: shake 0.5s; border-color: var(--danger); }
        
        .flash-green { animation: flashGreen 0.5s; }
        @keyframes flashGreen {
            0% { box-shadow: 0 0 0px var(--hp-color); }
            50% { box-shadow: 0 0 30px var(--hp-color); }
            100% { box-shadow: 0 0 0px var(--hp-color); }
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes flashRed { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    </style>
</head>
<body>
    <!-- Background Layer for transitions -->
    <div id="background-layer"></div>

    <!-- Start Screen -->
    <div id="start-screen" class="screen-overlay" style="display: flex;">
        <!-- ★★★ 新增：Intro Video (預設隱藏) ★★★ -->
        <!-- 請將 src 換成您的影片連結 -->
        <video id="intro-video" src="https://raw.githubusercontent.com/xotarios/N2-kanji-yuusha/refs/heads/main/images/n2yuusha_moving.mp4" playsinline muted></video>
        <div class="result-content">
            <h1 class="title-logo">N2漢字勇者</h1>
            <p style="margin-bottom: 5px;">日本語の漢字読みRPG　beta</p>
            <button onclick="playIntroSequence()" style="font-size: 1.5rem; padding: 20px 50px; margin-top: 0;">冒険を始める</button>
            
            <div class="start-credits">
                制　作：<a href="https://linktr.ee/Xotarios/" style="color:#c6f2ff;">Xotarios</a>（第一日語何先生）+ AI協力<br>
                音　楽：<a href="https://amachamusic.chagasi.com/index.html" style="color:#c6f2ff;">甘茶の音楽工房</a> & <a href="https://youfulca.com/" style="color:#c6f2ff;">ユーフルカ</a><br>
                効果音：<a href="https://soundeffect-lab.info/" style="color:#c6f2ff;">効果音ラボ</a>
            </div>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen" style="display:none;">
        <div class="loading-text">漢字の町へ移動中...</div>
        <div class="progress-bar-bg">
            <div class="progress-bar-fill"></div>
        </div>
    </div>

    <!-- Stage Select Screen -->
    <div id="stage-select-screen" class="screen-overlay">
        <div class="result-content">
            <h2 class="title-logo">行き先を選択せよ</h2>
            <p>各エリアには異なる言葉が待ち受けている…</p>
            <div id="stage-container" class="stage-grid">
                <!-- Buttons generated by JS -->
            </div>
            <button onclick="backToTitle()" style="margin-top: 30px; background: #555;">タイトル画面に戻る</button>
            <div style="margin-top: 20px; padding-top: 10px; border-top: 1px solid #444;">
                <label style="color: #666; font-size: 0.8rem; cursor: pointer;">
                    <input type="checkbox" id="debug-toggle" onchange="toggleDebugMode()"> Debug Mode
                </label>
            </div>
        </div>
    </div>

    <!-- Main Game Screen -->
    <div class="game-container" id="game-screen" style="display:none;">
        <div class="header">
            <div class="header-left">
                <div>正解数: <span id="level-display">0</span> / <span id="total-display">20</span></div>
                <div id="stage-name-display" class="stage-name-small"></div>
            </div>
            <div class="hp-container">
                <div class="hp-bar" id="hp-bar"></div>
                <div class="hp-text">HP: <span id="hp-val">120</span></div>
            </div>
        </div>

        <!-- Boss UI -->
        <div id="boss-section">
            <div class="boss-image-container">
                <img src="" class="boss-img" id="boss-img">
            </div>
            <div class="boss-hp-bar-container">
                <div class="boss-hp-bar" id="boss-hp-bar"></div>
            </div>
            <div class="boss-timer">残り時間：<span id="boss-timer-val">45</span> 秒</div>
        </div>
        
        <div class="kanji-display">
            <div id="hint-display" class="hint-overlay"></div>
            <span id="kanji-text"></span>
        </div>

        <div class="info-box">
            <div class="meaning" id="meaning-text"></div>
            <div class="example-sentence" id="sentence-text"></div>
            <div class="trans-sentence">（<span id="trans-text"></span>）</div>
        </div>

        <!-- Input Mode Switch -->
        <div class="keyboard-switch">
            <label class="switch-label">
                <input type="checkbox" id="vk-toggle" class="switch-input" checked onchange="toggleInputMode()">
                仮想キーボードを使用（推奨）
            </label>
        </div>

        <div class="input-area">
            <div class="input-wrapper">
                <input type="text" id="answer-input" 
                    placeholder="読み方（送り仮名含む）" 
                    autocomplete="off" 
                    autocorrect="off" 
                    autocapitalize="off" 
                    spellcheck="false"
                    enterkeyhint="done">
                
                <!-- Overlay for Virtual Keyboard -->
                <div id="virtual-input-display"></div>
            </div>
                   
            <div class="btn-group">
                <button onclick="checkAnswer()" id="submit-btn">決定</button>
                <button onclick="useHint()" id="hint-btn">ヒント <span class="hint-cost">-5 HP</span></button>
            </div>
            <button onclick="manualNext()" id="next-btn" class="next-btn">次へ進む</button>
        </div>
        
        <!-- Virtual Keyboard (QWERTY) -->
        <div id="virtual-keyboard">
            <div class="key-row">
                <div class="key-btn" onclick="vkPress('q')">q</div>
                <div class="key-btn" onclick="vkPress('w')">w</div>
                <div class="key-btn" onclick="vkPress('e')">e</div>
                <div class="key-btn" onclick="vkPress('r')">r</div>
                <div class="key-btn" onclick="vkPress('t')">t</div>
                <div class="key-btn" onclick="vkPress('y')">y</div>
                <div class="key-btn" onclick="vkPress('u')">u</div>
                <div class="key-btn" onclick="vkPress('i')">i</div>
                <div class="key-btn" onclick="vkPress('o')">o</div>
                <div class="key-btn" onclick="vkPress('p')">p</div>
            </div>
            <div class="key-row">
                <div class="key-btn" onclick="vkPress('a')">a</div>
                <div class="key-btn" onclick="vkPress('s')">s</div>
                <div class="key-btn" onclick="vkPress('d')">d</div>
                <div class="key-btn" onclick="vkPress('f')">f</div>
                <div class="key-btn" onclick="vkPress('g')">g</div>
                <div class="key-btn" onclick="vkPress('h')">h</div>
                <div class="key-btn" onclick="vkPress('j')">j</div>
                <div class="key-btn" onclick="vkPress('k')">k</div>
                <div class="key-btn" onclick="vkPress('l')">l</div>
            </div>
            <div class="key-row">
                <div class="key-btn" onclick="vkPress('z')">z</div>
                <div class="key-btn" onclick="vkPress('x')">x</div>
                <div class="key-btn" onclick="vkPress('c')">c</div>
                <div class="key-btn" onclick="vkPress('v')">v</div>
                <div class="key-btn" onclick="vkPress('b')">b</div>
                <div class="key-btn" onclick="vkPress('n')">n</div>
                <div class="key-btn" onclick="vkPress('m')">m</div>
                <div class="key-btn wide" onclick="vkPress('bs')">⌫</div>
            </div>
        </div>

        <div id="message-area"></div>

        <!-- In-game Return Button -->
        <button onclick="goToStageSelect()" class="return-btn">◀ 諦める</button>
    </div>

    <!-- Result Screen -->
    <div id="result-screen" class="screen-overlay">
        <div class="result-content">
            <h1 id="result-title"></h1>
            <div id="result-boss-area" style="display:none;">
                <div class="boss-display-container">
                    <div class="boss-text-style boss-title-label" id="result-boss-title"></div>
                    
                    <img id="result-boss-img" src="" style="width:120px; height:120px; object-fit:contain; filter: drop-shadow(0 0 10px #fff);">
                    
                    <div class="boss-text-style boss-name-label">
                        <span class="boss-name-ruby" id="result-boss-kana"></span>
                        <span id="result-boss-name"></span>
                    </div>
                </div>
                <!-- 結果對話框 -->
                <div class="boss-dialogue" id="result-dialogue"></div>
            </div>
            
            <p id="result-msg"></p>

            <div id="review-list" style="margin-top: 20px;"></div>

            <div id="password-reward-container" class="password-reward-box" style="display:none;">
                <div style="font-size:0.9rem;">終焉の城　入城暗号獲得：</div>
                <div id="password-reward-text" class="password-text"></div>
            </div>

            <button onclick="goToStageSelect()" style="margin-top: 20px; padding: 15px 30px;">別のエリアへ</button>
        </div>
    </div>
    <!-- ★★★ 新增：Boss 進場 Overlay ★★★ -->
    <div id="boss-overlay">
        <!-- 1. 標題 -->
        <div class="boss-intro-banner hidden-el" id="intro-banner">
            <div class="boss-intro-title">ボスが現れました</div>
        </div>

        <!-- 2. Boss 顯示區 (身分 - 圖片 - 名字) -->
        <div class="boss-display-container hidden-el" id="intro-boss-container">
            <!-- 左：身分 -->
            <div class="boss-text-style boss-title-label" id="intro-boss-title">TITLE</div>
            
            <!-- 中：圖片 -->
            <div class="boss-intro-img-container">
                <img src="" id="intro-boss-img" class="boss-intro-img">
            </div>
            
            <!-- 右：名字 -->
            <div class="boss-text-style boss-name-label">
                <span class="boss-name-ruby" id="intro-boss-kana">kana</span>
                <span id="intro-boss-name">NAME</span>
            </div>
        </div>

        <!-- 3. 對話框 -->
        <div class="boss-dialogue hidden-el" id="intro-dialogue"></div>

        <!-- 4. 任務說明與按鈕 -->
        <div class="hidden-el" id="intro-controls" style="text-align:center; width:100%;">
            <div class="boss-intro-desc" id="boss-intro-text">
                制限時間40秒以内に5問正解せよ！
            </div>
            <button class="boss-start-btn" onclick="startActualBossBattle()">かかってこい！</button>
        </div>

    <div id="boss-section">
        <div class="boss-display-container">
                <div class="boss-text-style boss-title-label" id="battle-boss-title" style="font-size:1rem;"></div>
                
                <div class="boss-image-container">
                    <img src="" class="boss-img" id="boss-img">
                </div>
                
                <div class="boss-text-style boss-name-label" style="font-size:1rem;">
                    <span class="boss-name-ruby" id="battle-boss-kana"></span>
                    <span id="battle-boss-name"></span>
                </div>
            </div>
            
            <div class="boss-hp-bar-container">
                <div class="boss-hp-bar" id="boss-hp-bar"></div>
            </div>
            <div class="boss-timer">TIME: <span id="boss-timer-val">45</span></div>
    </div>
    <audio id="bgm-player" loop preload="auto"></audio>

<script>
    // ==========================================
    // Stage & Word Data
    // ==========================================

let stageData = null; 
let currentQ = null;
const DATA_URL = "https://raw.githubusercontent.com/xotarios/N2-kanji-yuusha/refs/heads/main/questions.json";
//const DATA_URL = "/questions.json"; //

document.addEventListener('click', function(e) {
        // 檢查點擊的元素是否為 Button 或者是 .stage-btn (關卡選擇鈕)
        const target = e.target;
        
        if (target.closest('.stage-btn')) {
            playSE('btn');
            return;
        }

        if (target.tagName === 'BUTTON' && !target.classList.contains('key-btn')) {
            
            // ★★★ 修改：決定按鈕 (submit-btn) 不播音效 ★★★
            if (target.id === 'submit-btn') {
                return; 
            }

            // ★★★ 修改：提示按鈕 (hint-btn) 播 Wrong 音效 ★★★
            if (target.id === 'hint-btn') {
                playSE('wrong');
                return;
            }

            // 其他按鈕 (如：Start, Back, Restart) 播普通音效
            playSE('btn');
        }
    });

    // ==========================================
    // Romaji to Hiragana Table (Updated)
    // ==========================================
    const kanaTable = {
        'a':'あ','i':'い','u':'う','e':'え','o':'お',
        'ka':'か','ki':'き','ku':'く','ke':'け','ko':'こ',
        'sa':'さ','si':'し','shi':'し','su':'す','se':'せ','so':'そ',
        'ta':'た','ti':'ち','chi':'ち','tu':'つ','tsu':'つ','te':'て','to':'と',
        'na':'な','ni':'に','nu':'ぬ','ne':'ね','no':'の',
        'ha':'は','hi':'ひ','hu':'ふ','fu':'ふ','he':'へ','ho':'ほ',
        'ma':'ま','mi':'み','mu':'む','me':'め','mo':'も',
        'ya':'や','yi':'い','yu':'ゆ','ye':'いぇ','yo':'よ',
        'ra':'ら','ri':'り','ru':'る','re':'れ','ro':'ろ',
        'wa':'わ','wo':'を','nn':'ん',
        'ga':'が','gi':'ぎ','gu':'ぐ','ge':'げ','go':'ご',
        'za':'ざ','zi':'じ','ji':'じ','zu':'ず','ze':'ぜ','zo':'ぞ',
        'da':'だ','di':'ぢ','du':'づ','de':'で','do':'ど',
        'ba':'ば','bi':'び','bu':'ぶ','be':'べ','bo':'ぼ',
        'pa':'ぱ','pi':'ぴ','pu':'ぷ','pe':'ぺ','po':'ぽ',
        'vu':'ゔ',
        'xtu':'っ','xtsu':'っ','ltu':'っ','ltsu':'っ', 
        'kya':'きゃ','kyu':'きゅ','kyo':'きょ',
        'sha':'しゃ','shu':'しゅ','sho':'しょ','sya':'しゃ','syu':'しゅ','syo':'しょ',
        'cha':'ちゃ','chu':'ちゅ','cho':'ちょ','tya':'ちゃ','tyu':'ちゅ','tyo':'ちょ',
        'nya':'にゃ','nyu':'にゅ','nyo':'にょ',
        'hya':'ひゃ','hyu':'ひゅ','hyo':'ひょ',
        'mya':'みゃ','myu':'みゅ','myo':'みょ',
        'rya':'りゃ','ryu':'りゅ','ryo':'りょ',
        'gya':'ぎゃ','gyu':'ぎゅ','gyo':'ぎょ',
        'ja':'じゃ','ju':'じゅ','jo':'じょ','jya':'じゃ','jyu':'じゅ','jyo':'じょ',
        'bya':'びゃ','byu':'びゅ','byo':'びょ',
        'pya':'ぴゃ','pyu':'ぴゅ','pyo':'ぴょ',
        'xya':'ゃ','xyu':'ゅ','xyo':'ょ','lya':'ゃ','lyu':'ゅ','lyo':'ょ',
        '-':'ー'
    };

    // ==========================================
    // Game State & Variables
    // ==========================================
    let hp = 120;
    const MAX_HP = 120;
    let currentQuestions = [];
    let currentIndex = 0;
    let correctCount = 0;
    let hintLevel = 0; 
    let gameHistory = []; 
    let mistakeCount = 0; 
    let isVirtualKeyboard = true; 
    let romajiBuffer = ""; 
    let currentStageId = null; //用來儲存「當前顯示的題目物件」
    
    // Boss State
    let isBossBattle = false;
    let bossHP = 100;
    let maxBossHP = 100;
    let bossTimer = 45;
    let bossInterval = null;
    let bossDefeatedAt = -1;

    // Boss & Demon Castle Logic
    let isDemonCastleMode = false; // 是否為魔王城模式
    let demonCastleProgress = 0;   // 魔王城進度 (0-50)
    let activeBossData = null;     // 當前 Boss 的資料 (用於隨機抽取 Mid-Boss)
    let usedBossKeys = [];         // 已使用過的 Boss Key (避免重複出現)
    let isFinalBoss = false;       // 是否為最終魔王
    let bossQuestionCount = 0;     // 當前 Boss 戰已出題數 (用於判斷頭2題)
    let currentBossQuestionPool = [];

    let isDebugMode = false; // 新增 Debug 狀態變數

    const PASS_COST = 5;

    // ==========================================
    // DOM Elements
    // ==========================================
    const body = document.body;
    const bgLayer = document.getElementById('background-layer');
    const hpBar = document.getElementById('hp-bar');
    const hpVal = document.getElementById('hp-val');
    const levelDisp = document.getElementById('level-display');
    const totalDisp = document.getElementById('total-display');
    const stageNameDisp = document.getElementById('stage-name-display'); // 小字 Stage Name
    const kanjiText = document.getElementById('kanji-text');
    const hintDisp = document.getElementById('hint-display');
    const meaningText = document.getElementById('meaning-text');
    const sentenceText = document.getElementById('sentence-text');
    const transText = document.getElementById('trans-text');
    const answerInput = document.getElementById('answer-input');
    const virtualDisplay = document.getElementById('virtual-input-display');
    const hintBtn = document.getElementById('hint-btn');
    const msgArea = document.getElementById('message-area');
    const gameContainer = document.querySelector('.game-container');
    const nextBtn = document.getElementById('next-btn');
    const submitBtn = document.getElementById('submit-btn');
    const vkDiv = document.getElementById('virtual-keyboard');
    const vkToggle = document.getElementById('vk-toggle');
    const startScreen = document.getElementById('start-screen');
    const stageScreen = document.getElementById('stage-select-screen');
    const gameScreen = document.getElementById('game-screen');
    const resultScreen = document.getElementById('result-screen');
    const stageContainer = document.getElementById('stage-container');
    const bossSection = document.getElementById('boss-section');
    const bossHpBar = document.getElementById('boss-hp-bar');
    const bossTimerVal = document.getElementById('boss-timer-val');
    const bossImgElement = document.getElementById('boss-img');
    const bossOverlay = document.getElementById('boss-overlay');
    const introBossImg = document.getElementById('intro-boss-img');
    const bossIntroText = document.getElementById('boss-intro-text');

    const BGM_FILES = {
        menu: "https://github.com/xotarios/N2-kanji-yuusha/raw/refs/heads/main/bgm/natsuyasuminotanken.mp3", 
        boss: "https://github.com/xotarios/N2-kanji-yuusha/raw/refs/heads/main/bgm/norainutonoranekonokousou.mp3",
        finalBoss: "https://github.com/xotarios/N2-kanji-yuusha/raw/refs/heads/main/bgm/odysseia.mp3"
    };

    const SE_FILES = {
        btn: "https://github.com/xotarios/N2-kanji-yuusha/raw/refs/heads/main/se/%E6%B1%BA%E5%AE%9A%E3%83%9C%E3%82%BF%E3%83%B3%E3%82%92%E6%8A%BC%E3%81%9923.mp3",
        correct: "https://github.com/xotarios/N2-kanji-yuusha/raw/refs/heads/main/se/%E6%B1%BA%E5%AE%9A%E3%83%9C%E3%82%BF%E3%83%B3%E3%82%92%E6%8A%BC%E3%81%9947.mp3",
        wrong: "https://github.com/xotarios/N2-kanji-yuusha/raw/refs/heads/main/se/%E5%B0%8F%E3%83%91%E3%83%B3%E3%83%81.mp3",
        boss_hit: "https://github.com/xotarios/N2-kanji-yuusha/raw/refs/heads/main/se/%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%E5%91%BD%E4%B8%AD.mp3",
        timer: "https://github.com/xotarios/N2-kanji-yuusha/raw/refs/heads/main/se/beep5.mp3",
        warning: "https://github.com/xotarios/N2-kanji-yuusha/raw/refs/heads/main/se/teki_unit.mp3"
    };

    const bgmPlayer = document.getElementById('bgm-player');
    bgmPlayer.volume = 0.4; // 設定音量 (0.0 - 1.0)

    function playBGM(url) {
        if (!url) return;
        
        // 如果已經在播同一首，就不要重頭播
        // 注意：有些 CDN URL 可能會變，這裡做簡單判斷
        if (bgmPlayer.src === url && !bgmPlayer.paused) return;

        bgmPlayer.src = url;
        bgmPlayer.play().catch(e => console.log("BGM Autoplay blocked:", e));
    }

    function playSE(key) {
        if (!SE_FILES[key]) return;
        
        // 每次建立新的 Audio 物件，確保可以重疊播放（例如連按按鈕）
        const audio = new Audio(SE_FILES[key]);
        audio.volume = 0.8; // 音效音量
        audio.play().catch(e => {}); // 忽略自動播放限制錯誤
    }

    function playIntroSequence() {
        const startScreen = document.getElementById('start-screen');
        const content = document.querySelector('#start-screen .result-content');
        const video = document.getElementById('intro-video');
        
        // 1. 隱藏所有文字及按鈕
        content.style.display = 'none';
        
        // 2. 顯示並播放影片 (背景自動被遮住)
        video.style.display = 'block';
        video.play().catch(e => console.log("Video play failed", e));
        
        // 3. 第 2 秒開始變暗 (Fade Out)
        setTimeout(() => {
            startScreen.classList.add('fading-out');
        }, 2000);

        // 4. 第 3 秒強制結束 -> 進入 Loading
        setTimeout(() => {
            startScreen.style.display = 'none'; // 移除 Start Screen
            video.pause(); // 停止影片
            showLoadingScreen(); // 進入 Loading
        }, 3000);
    }

    function showLoadingScreen() {
        const loadingScreen = document.getElementById('loading-screen');
        const barFill = document.querySelector('.progress-bar-fill');
        
        // 顯示 Loading 畫面
        loadingScreen.style.display = 'flex';
        
        // 強制重繪 (Reflow) 以確保 CSS transition 生效
        void loadingScreen.offsetWidth; 
        
        // 觸發進度條動畫 (0% -> 100%)
        barFill.style.width = '100%';
        
        // 開始背景下載 (如果不影響動畫流暢度，可以放在這)
        if (!stageData) {
            loadStageData(); // 偷偷在背景下載題目
        }

        // 5. 1秒後 (Total 4秒) -> 進入 Stage Menu
        setTimeout(() => {
            loadingScreen.style.display = 'none';
            goToStageSelect(); // 呼叫原本的進入選單函數
        }, 1000);
    }

    // ==========================================
    // Scene Management
    // ==========================================
    function goToStageSelect() {
        playBGM(BGM_FILES.menu);
        startScreen.style.display = 'none';
        resultScreen.style.display = 'none';
        gameScreen.style.display = 'none';
        stageScreen.style.display = 'flex';
        
        // 重置背景層
        document.body.classList.remove('stage-entering');
        bgLayer.style.backgroundImage = 'none';
        if (!stageData) {
            loadStageData();
        } else {
            renderStageButtons();
        }

        playBGM(BGM_FILES.menu);

        // 確保按鈕已渲染 (如果在 Loading 時還沒下載完，這裡會再檢查一次)
        if (stageData) {
            renderStageButtons();
        } else {
            // 萬一 loading 畫面那 1 秒還沒下載完，顯示載入中
            // loadStageData 已經在 showLoadingScreen 呼叫過了，這裡等待即可
            document.getElementById('stage-container').innerHTML = '<div style="color:white; text-align:center;">読み込み中...</div>';
        }

    }

    function backToTitle() {
        // 1. 隱藏 Stage Select
        stageScreen.style.display = 'none';
        
        // 2. 取得首頁相關元素
        const startScreen = document.getElementById('start-screen');
        const content = document.querySelector('#start-screen .result-content');
        const video = document.getElementById('intro-video');
        const bgm = document.getElementById('bgm-player');

        // 3. 重置首頁狀態 (還原 Intro 動畫前的樣子)
        startScreen.style.display = 'flex';       // 顯示首頁
        startScreen.classList.remove('fading-out'); // 移除變暗濾鏡
        content.style.display = 'block';          // 重新顯示標題與按鈕
        
        // 4. 重置影片
        video.style.display = 'none';             // 隱藏影片
        video.pause();
        video.currentTime = 0;

        // 5. 停止 BGM (回到初始靜音狀態)
        bgm.pause();
        bgm.currentTime = 0;
    }

    function renderStageButtons() {
        stageContainer.innerHTML = "";
        for (const [key, data] of Object.entries(stageData)) {
            const btn = document.createElement('div');
            btn.className = 'stage-btn';
            
            // Set Background with dimming
            btn.style.background = `linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('${data.img}')`;
            btn.style.backgroundSize = "cover"; 
            btn.style.backgroundPosition = "center";

            btn.innerHTML = `<div>${data.name}</div><div class="stage-desc">${data.desc}</div>`;
            btn.onclick = () => initGame(key);
            stageContainer.appendChild(btn);
        }
    }

    function toggleDebugMode() {
        isDebugMode = document.getElementById('debug-toggle').checked;
        console.log("Debug Mode:", isDebugMode ? "ON" : "OFF");
    }

    // ==========================================
    // Game Initialization
    // ==========================================
    async function initGame(stageKey) {
        if (stageKey === 'demon_castle') {
            const password = prompt("入城暗号（各エリアのボスを撃破したら貰えます。ひらがなで入力）");
            if (!password) return; 
            
            const inputHash = await sha256(password);
            const correctHash = "38d7a13a71896294f0650098eb57d0724bdce53346016a68c9b8fd4e2e9a4c16"; 

            if (inputHash !== correctHash) {
                alert("入城暗号が違います。");
                return;
            }
            
            isDemonCastleMode = true;
            demonCastleProgress = 0;
        } else {
            isDemonCastleMode = false;
        }

        currentStageId = stageKey;
        const stage = stageData[stageKey];

        if (stage.bgm) {
            playBGM(stage.bgm);
        }

        // 1. 設定背景層 (獨立層)
        bgLayer.style.backgroundImage = `url('${stage.img}')`;
        document.body.classList.remove('stage-entering'); // Reset animation class
        // 2. 設定 Game Container (變暗濾鏡)
        gameContainer.style.background = `linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('${stage.img}')`;
        gameContainer.style.backgroundSize = "cover";
        gameContainer.style.backgroundPosition = "center";

        // Setup Game Logic
        hp = 120;
        updateHP(0);
        currentIndex = 0;
        correctCount = 0;
        demonCastleProgress = 0;
        gameHistory = [];
        isBossBattle = false;
        isFinalBoss = false;
        activeBossData = null;
        bossDefeatedAt = -1;
        usedBossKeys = [];
        clearInterval(bossInterval);
        bossSection.style.display = 'none';

        let targetCount;
        if (isDemonCastleMode) {
            targetCount = isDebugMode ? 10 : 50; // Debug:10, Normal:50
        } else {
            targetCount = isDebugMode ? 3 : 20;  // Debug:3, Normal:20
        }
        totalDisp.innerText = targetCount;
        levelDisp.innerText = 0;
        
        // UI Info
        stageNameDisp.innerText = `🚩 ${stage.name}`;

        // ★★★ 題庫準備 ★★★
        if (isDemonCastleMode) {
            // 魔王城：將所有其他 Stage 的 words 合併
            let allWords = [];
            for (const key in stageData) {
                if (key !== 'demon_castle' && stageData[key].words) {
                    allWords = allWords.concat(stageData[key].words);
                }
            }
            if (allWords.length === 0) { alert("データ不足"); return; }
            currentQuestions = allWords.sort(() => 0.5 - Math.random());
            // 魔王城不設 currentIndex 限制，因為我們會不斷隨機抽
            currentIndex = 0; 
        } else {
            // 普通關卡
            let source = stage.words;
            if(!source || source.length === 0) { alert("No Data"); return; }
            currentQuestions = [...source].sort(() => 0.5 - Math.random());
            currentIndex = 0;
        }
        
        // 3. 執行過場動畫 (Transition)
        stageScreen.style.display = 'none';
        document.body.classList.add('stage-entering'); // Trigger CSS scale/dim animation
        
        // 延遲顯示遊戲畫面
        setTimeout(() => {
            gameScreen.style.display = 'block';
            toggleInputMode();
            loadQuestion();
        }, 1500);
    }

    // ==========================================
    // Question Loading Logic
    // ==========================================
    function loadQuestion() {
        // 每次加載問題時，回復 GameContainer 的背景 (移除綠色，變回黑色濾鏡)
        if (currentStageId && stageData[currentStageId]) {
            const imgUrl = stageData[currentStageId].img;
            gameContainer.style.background = `linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('${imgUrl}')`;
            gameContainer.style.backgroundSize = "cover";
            gameContainer.style.backgroundPosition = "center";
        }

        // 判斷是否進入 Boss 戰
        if (!isBossBattle) {
            // 設定目標數值 (Debug vs Normal)
            const normalBossTarget = isDebugMode ? 3 : 20;       // 普通關卡: 3題 vs 20題
            const dcBossInterval = isDebugMode ? 2 : 10;         // 魔王城間隔: 2題 vs 10題
            const dcFinalTarget = isDebugMode ? 10 : 50;         // 魔王城Final: 10題 vs 50題

            if (isDemonCastleMode) {
                // 魔王城邏輯
                if (demonCastleProgress > 0 && demonCastleProgress % dcBossInterval === 0) {
                    // ★★★ 關鍵修正：檢查這個進度的 Boss 是否已經打贏過 ★★★
                    if (demonCastleProgress !== bossDefeatedAt) {
                        // 如果達到 Final 目標
                        if (demonCastleProgress === dcFinalTarget) {
                            triggerBossIntro(true);
                        } else {
                            triggerBossIntro(false);
                        }
                        return; 
                    }
                }
            } else {
                // 普通關卡邏輯
                if (correctCount >= normalBossTarget) {
                    triggerBossIntro(false);
                    return;
                }
            }
        } else {
            // Boss 戰中：檢查 Boss HP
            if (bossHP <= 0) {
                handleBossVictory();
                return;
            }
        }

        // Game Over & End Checks
        if (hp <= 0) {
            clearInterval(bossInterval);
            endGame(false);
            return;
        }
        
        // 普通模式題庫用完
        if (!isDemonCastleMode && !isBossBattle && currentIndex >= currentQuestions.length) {
            if (isDemonCastleMode) {
                 // 重新生成題庫 (從 stageData 再抓一次)
                 let allWords = [];
                 for (const key in stageData) {
                     if (key !== 'demon_castle' && stageData[key].words) {
                         allWords = allWords.concat(stageData[key].words);
                     }
                 }
                 currentQuestions = allWords.sort(() => 0.5 - Math.random());
             } else {
                 // 普通模式題庫用完 = 勝利
                 endGame(true);
                 return;
             }
        }

        if (isBossBattle) {
            currentQ = getBossQuestion();
        } else {
            // 普通題目
            if (isDemonCastleMode) {
                // ★★★ 魔王城修正：使用「抽牌」方式 (取出並移除)，確保不重複 ★★★
                // shift() 會取出陣列第一個元素，並將其從陣列中刪除
                if (currentQuestions.length > 0) {
                    currentQ = currentQuestions.shift();
                } else {
                    // 萬一真的空了 (理論上上面有 refill 邏輯，這裡做保險)
                    endGame(true); return; 
                }
            } else {
                // 普通關卡：依序出題 (currentIndex 會在答對時 +1)
                // 這裡檢查是否超出範圍
                if (currentIndex < currentQuestions.length) {
                    currentQ = currentQuestions[currentIndex];
                } else {
                    endGame(true); return;
                }
            }
        }
        const displayQ = currentQ; // 用於顯示

        // UI
        levelDisp.innerText = isDemonCastleMode ? demonCastleProgress : correctCount;
        let targetCount;
        if (isDemonCastleMode) {
            targetCount = isDebugMode ? 10 : 50;
        } else {
            targetCount = isDebugMode ? 3 : 20;
        }
        totalDisp.innerText = targetCount;
        kanjiText.innerText = displayQ.kanji;
        meaningText.innerText = "【意味】" + displayQ.meaning;
        sentenceText.innerHTML = "【例句】" + displayQ.sentence;
        transText.innerText = displayQ.trans;
        
        // Input Reset
        answerInput.value = "";
        answerInput.disabled = false;
        romajiBuffer = "";
        updateVirtualDisplay();
        msgArea.innerText = "";
        nextBtn.style.display = "none";
        
        // Hint Reset
        hintLevel = 0;
        mistakeCount = 0;
        hintDisp.innerText = "";
        hintDisp.classList.remove("hint-answer");
        
        hintBtn.disabled = false;
        if (isBossBattle && isFinalBoss) {
            hintBtn.innerHTML = 'ヒント'; 
        } else {
             hintBtn.innerHTML = 'ヒント1（仮名の数） <span class="hint-cost">-5 HP</span>';
        }
        submitBtn.disabled = false;
        submitBtn.style.display = "block";
    }

    function triggerBossIntro(isFinal) {
        isFinalBoss = isFinal;
        
        // 設定 Boss 資料
        if (isDemonCastleMode) {
            if (isFinal) {
                activeBossData = stageData['demon_castle']; 
            } else {
                // ★★★ 修改：Mid Boss 防重複邏輯 ★★★
                // 1. 取得所有可用的關卡 Key (排除魔王城本身)
                const allKeys = Object.keys(stageData).filter(k => k !== 'demon_castle');
                
                // 2. 篩選出「還沒打過」的 Key
                let availableKeys = allKeys.filter(k => !usedBossKeys.includes(k));
                
                // 3. 如果所有 Boss 都打過了（例如 Debug 模式頻繁出 Boss），則重置清單，重新循環
                if (availableKeys.length === 0) {
                    usedBossKeys = [];
                    availableKeys = allKeys;
                }
                
                // 4. 隨機抽一個
                const randomKey = availableKeys[Math.floor(Math.random() * availableKeys.length)];
                
                // 5. 記錄起來
                usedBossKeys.push(randomKey);
                
                activeBossData = stageData[randomKey];
                // ★★★ 修改結束 ★★★
            }
        } else {
            activeBossData = stageData[currentStageId];
        }

        // 設定 Overlay 內容
        document.getElementById('intro-boss-title').innerText = activeBossData.bossTitle || "BOSS";
        document.getElementById('intro-boss-name').innerText = activeBossData.bossName || "???";
        document.getElementById('intro-boss-kana').innerText = activeBossData.bossNameKana || "";
        introBossImg.src = activeBossData.bossImg || "https://cdn-icons-png.flaticon.com/512/1998/1998610.png";
        
        if (isFinal) {
            bossIntroText.innerHTML = "FINAL BOSS出現！<br>制限時間80秒 - 10問正解せよ！<br><span style='color:red; font-size:0.8em;'>※ヒント使用不可・ミス大ダメージ</span>";
            // ★★★ 新增：在此處播放 Final Boss BGM ★★★
            playBGM(BGM_FILES.finalBoss);
        } else {
            bossIntroText.innerHTML = "ボスが現れました！<br>制限時間45秒 - 5問正解せよ！";
            // ★★★ 新增：在此處播放 Boss BGM ★★★
            playBGM(BGM_FILES.boss);
        }

        // 3. 重置動畫狀態 (隱藏所有元素)
        const banner = document.getElementById('intro-banner');
        const container = document.getElementById('intro-boss-container');
        const img = document.getElementById('intro-boss-img');
        const dialogue = document.getElementById('intro-dialogue');
        const controls = document.getElementById('intro-controls');

        banner.className = "boss-intro-banner hidden-el";
        container.className = "boss-display-container hidden-el";
        img.className = "boss-intro-img"; // 重置 zoom class
        dialogue.className = "boss-dialogue hidden-el";
        controls.className = "hidden-el";
        dialogue.innerHTML = ""; // 清空對白


        // 顯示 Overlay
        bossOverlay.style.display = 'flex';

        // 4. 開始動畫序列
        setTimeout(async () => {
            // Step 1: 標題彈出 + 警報聲
            playSE('warning');
            banner.classList.remove('hidden-el');
            banner.classList.add('anim-pop-in');

            await new Promise(r => setTimeout(r, 800));

            // Step 2: Boss 圖片 Zoom Out 進場 + 顯示名字
            container.classList.remove('hidden-el');
            img.classList.add('anim-boss-entry'); // 圖片縮放動畫

            await new Promise(r => setTimeout(r, 1500)); // 等圖片定格
            
            // Step 3: 顯示對話框並打字
            dialogue.classList.remove('hidden-el');
            let introText = activeBossData.dialogueIntro || "......";
            if (isDemonCastleMode && !isFinal) {
                if (activeBossData.dialogueDemonCastleIntro) {
                    introText = activeBossData.dialogueDemonCastleIntro;
                }
            }
            await typeWriter(introText, 'intro-dialogue', 30); // 打字速度

            // Step 4: 顯示按鈕
            controls.classList.remove('hidden-el');
            controls.classList.add('visible-el');

        }, 100);
    }

    function startActualBossBattle() {
        bossOverlay.style.display = 'none';
        bossSection.style.display = 'flex';
        
        isBossBattle = true;

        bossQuestionCount = 0; // 重置出題數

        // 準備 Boss 題庫池
        currentBossQuestionPool = []; // 清空

        if (isFinalBoss) {
            // Final Boss: 集合所有關卡的 Boss 題目
            for (const key in stageData) {
                if (stageData[key].bossWords) {
                    // 複製題目進池子
                    currentBossQuestionPool = currentBossQuestionPool.concat(stageData[key].bossWords);
                }
            }
        } else {
            // 普通 Boss: 只用該關卡 Boss 題目
            if (activeBossData.bossWords) {
                // 複製題目進池子 (使用 [...array] 複製，避免影響原資料)
                currentBossQuestionPool = [...activeBossData.bossWords];
            }
        }
        
        // 設定數值
        if (isFinalBoss) {
            bossHP = 200; // 需答對 10 題 (200 / 20)
            maxBossHP = 200;
            bossTimer = 80;
        } else {
            bossHP = 100; // 需答對 5 題 (100 / 20)
            maxBossHP = 100;
            bossTimer = 45;
        }

        document.getElementById('battle-boss-title').innerText = activeBossData.bossTitle || "";
        document.getElementById('battle-boss-name').innerText = activeBossData.bossName || "";
        document.getElementById('battle-boss-kana').innerText = activeBossData.bossNameKana || "";
        bossImgElement.src = activeBossData.bossImg || "https://cdn-icons-png.flaticon.com/512/1998/1998610.png";
        bossHpBar.style.width = "100%";
        bossTimerVal.innerText = bossTimer;

        const timerContainer = document.querySelector('.boss-timer');
        timerContainer.classList.remove('critical');
        timerContainer.classList.remove('shake-anim');
        
        // 啟動計時
        clearInterval(bossInterval);
        bossInterval = setInterval(() => {
            bossTimer--;
            bossTimerVal.innerText = bossTimer;
            if (bossTimer <= 10 && bossTimer > 0) {
                // 1. 播放音效
                playSE('timer');
                
                // 2. 變紅變大
                timerContainer.classList.add('critical');
                
                // 3. 晃動動畫 (利用 CSS Reflow 重置動畫)
                timerContainer.classList.remove('shake-anim');
                void timerContainer.offsetWidth; // Trigger Reflow
                timerContainer.classList.add('shake-anim');
            }

            if (bossTimer <= 0) {
                clearInterval(bossInterval);
                if (bossHP > 0) endGame(false);
            }
        }, 1000);
        
        loadQuestion();
    }

    function getBossQuestion() {
        bossQuestionCount++;
        
        // Final Boss: 從所有 Boss 題庫中隨機抽
        if (isFinalBoss) {
            let allBossWords = [];
            for (const key in stageData) {
                if (stageData[key].bossWords) {
                    allBossWords = allBossWords.concat(stageData[key].bossWords);
                }
            }
            if(allBossWords.length > 0) {
                return allBossWords[Math.floor(Math.random() * allBossWords.length)];
            }
            // Fallback if no boss words
            return currentQuestions[Math.floor(Math.random() * currentQuestions.length)];
        }
        
        // 普通 Boss / Mid Boss
        // 第 1-2 題：普通題庫
        if (bossQuestionCount <= 2) {
            if (isDemonCastleMode) {
                 const originWords = activeBossData.words;
                 
                 // 過濾掉已經在 gameHistory 出現過的題目
                 // 找出「還沒答過」的該關卡題目
                 const availableWords = originWords.filter(w => 
                     !gameHistory.some(history => history.kanji === w.kanji && history.reading === w.reading)
                 );

                 if (availableWords.length > 0) {
                     // 從沒答過的題目中隨機抽
                     return availableWords[Math.floor(Math.random() * availableWords.length)];
                 } else {
                     // 如果該關卡所有普通題目都答過了，就只好隨機抽
                     return originWords[Math.floor(Math.random() * originWords.length)];
                 }
            } else {
                 // 普通模式：繼續沿用 currentIndex 順序，確保不回頭
                 // 因為 loadQuestion 用 currentIndex，這裡也用 currentIndex
                 // 注意：handleCorrectAnswer 會 +1，所以這裡直接拿由它繼續
                 if (currentIndex < currentQuestions.length) {
                     return currentQuestions[currentIndex];
                 } else {
                     // 萬一題目不夠 (例如 Debug 模式題目少)，回傳最後一題或隨機
                     return currentQuestions[Math.floor(Math.random() * currentQuestions.length)];
                 }
            }
        } 
        // 第 3 題以後：Boss 專屬題庫 (從池中移除邏輯，保持不變)
        else {
            if (currentBossQuestionPool.length === 0) {
                if (activeBossData.bossWords) currentBossQuestionPool = [...activeBossData.bossWords];
                if (currentBossQuestionPool.length === 0) return currentQuestions[0]; // Fallback
            }
            const randomIndex = Math.floor(Math.random() * currentBossQuestionPool.length);
            const q = currentBossQuestionPool[randomIndex];
            currentBossQuestionPool.splice(randomIndex, 1);
            return q;
        }
    
        // 隨機選一個 index
        const randomIndex = Math.floor(Math.random() * currentBossQuestionPool.length);
            
            // 取出題目
        const q = currentBossQuestionPool[randomIndex];
            
            // ★ 關鍵：從池子中移除這題，避免重複 ★
        currentBossQuestionPool.splice(randomIndex, 1);
            
        return q;

    }


    function handleBossVictory() {
        clearInterval(bossInterval);
        isBossBattle = false;
        //bossSection.style.display = 'none';//
        const defaultDefeatedImg = "https://cdn-icons-png.flaticon.com/512/8890/8890786.png";
        if (activeBossData && activeBossData.bossDefeatedImg) {
            bossImgElement.src = activeBossData.bossDefeatedImg;
        } else {
            bossImgElement.src = defaultDefeatedImg;
        }
        
        if (isDemonCastleMode) {
            if (isFinalBoss) {
                // 為了讓玩家看到 Final Boss 的戰敗圖，延遲一點才跳轉
                setTimeout(() => {
                    endGame(true);
                }, 2000);
            } else {
                bossDefeatedAt = demonCastleProgress;

                if (stageData[currentStageId].bgm) {
                    playBGM(stageData[currentStageId].bgm);
                }

                updateHP(20); 
                msgArea.style.color = "#f1c40f";
                msgArea.innerText = "ボス撃破！HP +20 回復！";
                
                setTimeout(() => {
                    bossSection.style.display = 'none'; 
                    loadQuestion();
                }, 2000);
            }
        } else {
            // 普通關卡：延遲後通關
            setTimeout(() => {
                endGame(true);
            }, 2000);
        }
    }

     // ★★★負責下載 JSON ★★★
    async function loadStageData() {
        const container = document.getElementById('stage-container');
        // 顯示載入中文字
        container.innerHTML = '<div style="color:white; text-align:center; margin-top:50px; font-family:var(--font-ui);">データを読み込んでいます...<br>(Loading...)</div>';

        try {
            const response = await fetch(DATA_URL);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            stageData = await response.json(); // 將下載到的資料放入 stageData
            renderStageButtons(); // 資料到了，產生按鈕
        } catch (error) {
            console.error("Error loading stage data:", error);
            container.innerHTML = '<div style="color:#e74c3c; text-align:center; margin-top:50px;">データの読み込みに失敗しました。<br>インターネット接続を確認してください。</div>';
        }
    }

    async function sha256(message) {
        const msgBuffer = new TextEncoder().encode(message);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // ==========================================
    // Boss Battle Logic
    // ==========================================
    function startBossBattle() {
        isBossBattle = true;
        bossHP = 100;
        bossTimer = 45;
        
        // Boss Image
        const stage = stageData[currentStageId];
        bossImgElement.src = stage.bossImg || "https://cdn-icons-png.flaticon.com/512/1998/1998610.png"; 
        
        // UI Show
        bossSection.style.display = 'flex';
        bossHpBar.style.width = "100%";
        bossTimerVal.innerText = bossTimer;
        
        // Timer Start
        clearInterval(bossInterval);
        bossInterval = setInterval(() => {
            bossTimer--;
            bossTimerVal.innerText = bossTimer;
            
            if (bossTimer <= 0) {
                clearInterval(bossInterval);
                if (bossHP > 0) {
                    endGame(false); // Time over
                }
            }
        }, 1000);
        
        // Continue loading questions
        loadQuestion();
    }

    function updateHP(change) {
        hp += change;
        if (hp > MAX_HP) hp = MAX_HP;
        if (hp < 0) hp = 0;
        
        const pct = (hp / MAX_HP) * 100;
        hpBar.style.width = pct + "%";
        hpVal.innerText = hp;
        
        if (pct > 50) hpBar.style.background = "#2ecc71";
        else if (pct > 20) hpBar.style.background = "#f1c40f";
        else hpBar.style.background = "#e74c3c";

        if (change < 0) {
            gameContainer.classList.add('shake-anim');
            setTimeout(() => gameContainer.classList.remove('shake-anim'), 500);
        } else if (change > 0) {
            gameContainer.classList.add('flash-green');
            setTimeout(() => gameContainer.classList.remove('flash-green'), 500);
        }

        if (hp <= 0) {
            setTimeout(() => endGame(false), 1000);
        }
    }

    // ==========================================
    // Input & Keyboard Logic
    // ==========================================
    function toggleInputMode() {
        isVirtualKeyboard = vkToggle.checked;
        if (isVirtualKeyboard) {
            vkDiv.style.display = "block";
            answerInput.classList.add("virtual-active");
            answerInput.readOnly = true; 
            virtualDisplay.style.display = "flex";
            updateVirtualDisplay();
            answerInput.blur();
        } else {
            vkDiv.style.display = "none";
            answerInput.classList.remove("virtual-active");
            answerInput.readOnly = false;
            virtualDisplay.style.display = "none";
        }
    }

    function updateVirtualDisplay() {
        let ghost = "";
        if (isVirtualKeyboard && romajiBuffer.length > 0) {
            ghost = `<span class="ghost-text">${romajiBuffer}</span>`;
        }
        virtualDisplay.innerHTML = answerInput.value + ghost;
    }

    function vkPress(key) {
        if (navigator.vibrate) {
            navigator.vibrate(15);
        }
        if (answerInput.disabled) return;

        if (key === 'bs') {
            if (romajiBuffer.length > 0) {
                romajiBuffer = romajiBuffer.slice(0, -1);
            } else {
                answerInput.value = answerInput.value.slice(0, -1);
            }
        } else {
            romajiBuffer += key;
            
            if (kanaTable[romajiBuffer]) {
                answerInput.value += kanaTable[romajiBuffer];
                romajiBuffer = "";
            } else {
                // Special n handling
                if (romajiBuffer.length >= 2 && romajiBuffer[0] === 'n' && !['y','a','i','u','e','o'].includes(romajiBuffer[1])) {
                    if (romajiBuffer[1] === 'n') {
                        answerInput.value += 'ん';
                        romajiBuffer = "";
                    } else {
                        answerInput.value += 'ん';
                        romajiBuffer = romajiBuffer.substring(1);
                        if (kanaTable[romajiBuffer]) {
                             answerInput.value += kanaTable[romajiBuffer];
                             romajiBuffer = "";
                        }
                    }
                }
                // Small tsu handling
                if (romajiBuffer.length >= 2 && romajiBuffer[0] === romajiBuffer[1] && !['a','i','u','e','o','n'].includes(romajiBuffer[0])) {
                    answerInput.value += 'っ';
                    romajiBuffer = romajiBuffer.substring(1);
                }
                // Flush if too long
                if (romajiBuffer.length > 3) {
                    answerInput.value += romajiBuffer[0];
                    romajiBuffer = romajiBuffer.substring(1);
                }
            }
        }
        updateVirtualDisplay();
    }

    // ==========================================
    // Hint & Answer Checking
    // ==========================================
    function useHint() {
        if (isFinalBoss) {
            msgArea.style.color = "#e74c3c";
            msgArea.innerText = "作者の威圧でヒントが使えない！";
            return; // 禁止使用
        }

        const q = currentQ;
        
        if (hintLevel === 0) {
            updateHP(-5);
            hintLevel = 1;
            mistakeCount = 1;
            hintDisp.innerText = q.hint1;
            hintBtn.innerHTML = `ヒント2（ランダムかな表示） <span class="hint-cost">-5 HP</span>`;
        } else if (hintLevel === 1) {
            updateHP(-5);
            hintLevel = 2;
            mistakeCount = 2; 
            hintDisp.innerText = generateRandomHint(q);
            hintBtn.innerHTML = `パス <span class="hint-cost">-${PASS_COST} HP</span>`;
        } else if (hintLevel === 2) {
            triggerPass(q);
        }
    }

    function triggerPass(q) {
        updateHP(-PASS_COST);
        let correctR = Array.isArray(q.reading) ? q.reading[0] : q.reading;
        
        gameHistory.push({
            ...q,
            userAns: "パス",
            isCorrect: false,
            correctAnswer: correctR
        });
        
        // Show Pass in Input
        answerInput.value = "パスしました";
        romajiBuffer = "";
        updateVirtualDisplay();
        answerInput.disabled = true;
        
        // Show Answer Red
        hintDisp.innerHTML = `正解：${correctR}`;
        hintDisp.classList.add("hint-answer");
        msgArea.innerText = ""; 
        
        onWrongAnswerState();
    }

    function checkAnswer() {
        const userVal = answerInput.value.trim();
        if (!userVal) return;

        const q = currentQ;

        let isCorrect = false;
        let correctPrimary = Array.isArray(q.reading) ? q.reading[0] : q.reading; // 用於顯示答案
        
        // Context strict check
        if (q.strict) {
            if (userVal === q.reading) isCorrect = true;
            else if (userVal === q.altReading) {
                 msgArea.style.color = "#e74c3c";
                 msgArea.innerText = `不正解！文脈が違います。\n${q.altExplain}`;
                 handleWrongAnswer(q, userVal, true); 
                 return;
            } else isCorrect = false;
        } else {
            if (Array.isArray(q.reading)) {
                if (q.reading.includes(userVal)) isCorrect = true;
            } else {
                if (userVal === q.reading) isCorrect = true;
            }
        }

        if (isCorrect) {
            handleCorrectAnswer(q, userVal);
        } else {
            // Final Boss 懲罰
            if (isFinalBoss) {
                updateHP(-15); // 直接扣 15
                hintDisp.innerHTML = `正解：${correctPrimary}`;
                hintDisp.classList.add("hint-answer");
                msgArea.style.color = "#e74c3c";
                msgArea.innerText = `不正解！ダメージを受けた！」`;
                // 扣血，然後當作 MistakeCount 3 (直接輸掉這題)
                handleWrongAnswer(q, userVal, false, true); // true = force fail
            } else {
                handleWrongAnswer(q, userVal, false, false);
            }
        }
    }

    function handleCorrectAnswer(q, userVal) {
        updateHP(5);
        
        // Change Background Filter to Green
        if (currentStageId && stageData[currentStageId]) {
            const imgUrl = stageData[currentStageId].img;
            gameContainer.style.background = `linear-gradient(rgba(46, 204, 113, 0.6), rgba(46, 204, 113, 0.6)), url('${imgUrl}')`;
            gameContainer.style.backgroundSize = "cover";
            gameContainer.style.backgroundPosition = "center";
        }

        if (!isBossBattle) {
            if (isDemonCastleMode) {
                demonCastleProgress++;
                levelDisp.innerText = demonCastleProgress;
            } else {
                correctCount++;
                levelDisp.innerText = correctCount;
            }
        }
        
        msgArea.style.color = "#2ecc71";
        msgArea.innerText = "正解！";
        
        gameHistory.push({ ...q, userAns: userVal, isCorrect: true });
        
        // Boss Damage
        if (isBossBattle) {
            // Boss 戰：播放受傷音效
            playSE('boss_hit');
            
            bossHP -= 20; 
            if (bossHP < 0) bossHP = 0;
            
            const hpPercent = (bossHP / maxBossHP) * 100;
            bossHpBar.style.width = `${hpPercent}%`;
            
            // Flash effect
            bossImgElement.style.filter = "brightness(5) sepia(1) hue-rotate(-50deg) saturate(5)";
            setTimeout(() => {
                bossImgElement.style.filter = ""; 
            }, 200);
        } else {
            // 一般戰：播放正確音效
            playSE('correct');
        }

        submitBtn.disabled = true;
        hintBtn.disabled = true;
        
        setTimeout(() => {
            currentIndex++; // 普通模式下有用，魔王城模式下 currentIndex 雖有增加但 loadQuestion 不會用它
            loadQuestion();
        }, 1000);
    }

    function handleWrongAnswer(q, userVal, isContextError, forceFail = false) {
        if (userVal || forceFail) {
            playSE('wrong');
        }
        
        let correctR = Array.isArray(q.reading) ? q.reading[0] : q.reading;
        
        if (forceFail) {
            mistakeCount = 2;
        }
        
        if (mistakeCount === 0) {
            // 1st Mistake
            updateHP(-5);
            mistakeCount = 1;
            hintLevel = 1;
            hintDisp.innerText = q.hint1;
            hintBtn.innerHTML = `ヒント2（ランダムかな表示） <span class="hint-cost">-5 HP</span>`;
            if(!isContextError) {
                msgArea.style.color = "#e74c3c";
                msgArea.innerText = "不正解。もう一度！";
            }
        } 
        else if (mistakeCount === 1) {
            // 2nd Mistake
            updateHP(-5);
            mistakeCount = 2;
            hintLevel = 2;
            hintDisp.innerText = generateRandomHint(q);
            hintBtn.innerHTML = `パス <span class="hint-cost">-${PASS_COST} HP</span>`;

            if(!isContextError) {
                msgArea.style.color = "#e74c3c";
                msgArea.innerText = "不正解。最後のチャンス！";
            }
        }
        else if (mistakeCount === 2) {
            // 3rd Mistake (Fail)
            if (!forceFail) {
                updateHP(-5);
            }
            
            hintDisp.innerHTML = `正解：${correctR}`;
            hintDisp.classList.add("hint-answer");
            if (!forceFail) {
                msgArea.innerText = ""; 
            }

            answerInput.disabled = true;
            
            gameHistory.push({ 
                ...q, 
                userAns: userVal, 
                isCorrect: false,
                correctAnswer: correctR
            });
            onWrongAnswerState();
        }
    }

    function onWrongAnswerState() {
        answerInput.disabled = true;
        submitBtn.style.display = "none";
        hintBtn.disabled = true;
        nextBtn.style.display = "block";
    }

    function typeWriter(text, elementId, speed = 50) {
        const element = document.getElementById(elementId);
        element.innerHTML = "";
        let i = 0;
        
        return new Promise(resolve => {
            function type() {
                if (i < text.length) {
                    element.innerHTML += text.charAt(i);
                    i++;
                    setTimeout(type, speed);
                } else {
                    resolve(); // 完成
                }
            }
            type();
        });
    }

    function manualNext() {
        currentIndex++;
        loadQuestion();
    }

    answerInput.addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            if(!submitBtn.disabled && submitBtn.style.display !== "none") {
                checkAnswer();
            } else if (nextBtn.style.display === "block") {
                manualNext();
            }
        }
    });

    function generateRandomHint(q) {
        // 取得讀音 (如果是多讀音陣列，取第一個)
        const reading = Array.isArray(q.reading) ? q.reading[0] : q.reading;
        const hint1 = q.hint1;

        // 1. 找出所有被隱藏 (●) 的位置 index
        let hiddenIndices = [];
        for (let i = 0; i < hint1.length; i++) {
            if (hint1[i] === '●') {
                hiddenIndices.push(i);
            }
        }

        const hiddenCount = hiddenIndices.length;

        // 2. 根據隱藏數量決定要公開多少個字
        // 只有 1 個：無法再給提示
        if (hiddenCount <= 1) {
            return "（これ以上ヒントが出せない）";
        }

        let revealNum = 0;
        if (hiddenCount >= 2 && hiddenCount <= 4) {
            revealNum = 1;
        } else if (hiddenCount >= 5 && hiddenCount <= 7) {
            revealNum = 2;
        } else if (hiddenCount >= 8) {
            revealNum = 3;
        }

        // 3. 隨機抽出要公開的位置
        // 洗牌 (Fisher-Yates 簡化版)
        const shuffled = hiddenIndices.sort(() => 0.5 - Math.random());
        const selectedIndices = shuffled.slice(0, revealNum);

        // 4. 組合新的 Hint 字串
        let newHint = "";
        for (let i = 0; i < reading.length; i++) {
            if (selectedIndices.includes(i)) {
                // 這是被選中要公開的字
                newHint += reading[i];
            } else if (hiddenIndices.includes(i)) {
                // 這是原本隱藏，且沒被選中的 -> 繼續隱藏
                newHint += "●";
            } else {
                // 這是原本就顯示的字 (送假名)
                newHint += reading[i];
            }
        }
        return newHint;
    }
    
function endGame(isWin) {
        clearInterval(bossInterval);
        document.body.classList.remove('stage-entering');
        
        gameScreen.style.display = 'none';
        resultScreen.style.display = 'flex';
        
        const title = document.getElementById('result-title');
        const msg = document.getElementById('result-msg');
        const list = document.getElementById('review-list');
        
        // Boss UI Elements
        const resultArea = document.getElementById('result-boss-area');
        const resultImg = document.getElementById('result-boss-img');
        const resultTitle = document.getElementById('result-boss-title');
        const resultName = document.getElementById('result-boss-name');
        const resultKana = document.getElementById('result-boss-kana');
        const resultDialogue = document.getElementById('result-dialogue');
        
        // Password UI Elements
        const passContainer = document.getElementById('password-reward-container');
        const passText = document.getElementById('password-reward-text');
        
        list.innerHTML = "";
        
        // ★★★ 重置樣式 (預設為顯示所有資訊) ★★★
        resultImg.classList.remove('boss-silhouette');
        resultDialogue.style.display = "block";
        resultTitle.style.display = "block";           // 重置標題顯示
        resultName.parentElement.style.display = "block"; // 重置名字顯示
        passContainer.style.display = "none";

        if (isWin) {
            title.innerText = "🎉 エリアクリア！ 🎉";
            title.style.color = "#2ecc71";
            msg.innerText = `見事、${correctCount}問正解で「${stageData[currentStageId].name}」を制覇しました！`;

            const bossData = activeBossData || stageData[currentStageId];

            if (bossData && bossData.bossDefeatedImg) {
                resultArea.style.display = "block";
                resultTitle.innerText = bossData.bossTitle || "";
                resultName.innerText = bossData.bossName || "";
                resultKana.innerText = bossData.bossNameKana || "";
                resultImg.src = bossData.bossDefeatedImg;
                resultDialogue.innerText = bossData.dialogueWin || "見事だ…！";
            } else {
                resultArea.style.display = "none";
            }

            const currentStage = stageData[currentStageId];
            if (currentStage && currentStage.passwordHint) {
                passText.innerText = currentStage.passwordHint;
                passContainer.style.display = "block";
            }

        } else {
            title.innerText = "💀 GAME OVER 💀";
            title.style.color = "#e74c3c";
            msg.innerText = `「${stageData[currentStageId].name}」の探索は失敗に終わりました…。`;
            
            let displayBoss = activeBossData || stageData[currentStageId];

            if (displayBoss) {
                resultArea.style.display = "block";
                resultImg.src = displayBoss.bossImg; 

                // ★★★ 修改邏輯：判斷是否見過 Boss ★★★
                if (!activeBossData) {
                    // Case 1: Boss 未出現就輸了
                    resultImg.classList.add('boss-silhouette'); // 變剪影
                    
                    resultDialogue.style.display = "none";      // 隱藏對白
                    resultTitle.style.display = "none";         // 隱藏稱號
                    resultName.parentElement.style.display = "none"; // 隱藏名字 (連同上面的假名)
                } else {
                    // Case 2: Boss 戰中輸了 (正常顯示)
                    resultTitle.innerText = displayBoss.bossTitle || "";
                    resultName.innerText = displayBoss.bossName || "";
                    resultKana.innerText = displayBoss.bossNameKana || "";
                    resultDialogue.innerText = displayBoss.dialogueLose || "出直してこい！";
                }
            } else {
                resultArea.style.display = "none";
            }
        }

        // 生成回顧列表
        gameHistory.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = 'result-item';
            
            const mark = item.isCorrect ? '<span class="mark correct">✔</span>' : '<span class="mark wrong">✖</span>';
            const ansDisplay = item.isCorrect 
                ? `<span class="correct-ans">${item.userAns}</span>` 
                : `<span class="your-ans">${item.userAns}</span> → <span class="correct-ans">${item.correctAnswer}</span>`;

            div.innerHTML = `
                <div>${mark}</div>
                <div class="review-details">
                    <div style="font-size:1.2em; font-weight:bold;">${item.kanji}</div>
                    <div style="font-size:0.9em; color:#aaa;">${item.meaning}</div>
                    <div style="font-style:italic; margin: 5px 0;">${item.sentence}</div>
                    <div style="font-size:0.8em; color:#aaa;">（${item.trans}）</div>
                    <div style="margin-top:5px;">回答: ${ansDisplay}</div>
                </div>
            `;
            list.appendChild(div);
        });
        
        playBGM(BGM_FILES.menu);
    }
</script>
</body>
</html>
